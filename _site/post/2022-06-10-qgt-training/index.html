<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Haky Im">
<meta name="dcterms.date" content="2022-06-10">

<title>Hakyimlab Notes - Transcriptome QGT Training 2023</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": true,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Hakyimlab Notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">Miscel</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/hakyimlab/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/hakyim" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#goals-of-lab" id="toc-goals-of-lab" class="nav-link active" data-scroll-target="#goals-of-lab">Goals of Lab</a></li>
  <li><a href="#inital-remarks" id="toc-inital-remarks" class="nav-link" data-scroll-target="#inital-remarks">Inital Remarks</a></li>
  <li><a href="#set-up" id="toc-set-up" class="nav-link" data-scroll-target="#set-up">Set Up</a>
  <ul class="collapse">
  <li><a href="#questionnaire-01" id="toc-questionnaire-01" class="nav-link" data-scroll-target="#questionnaire-01">Questionnaire 01</a></li>
  </ul></li>
  <li><a href="#transcriptome-wide-association-review" id="toc-transcriptome-wide-association-review" class="nav-link" data-scroll-target="#transcriptome-wide-association-review">Transcriptome-wide association (Review)</a>
  <ul class="collapse">
  <li><a href="#questionnaire-02" id="toc-questionnaire-02" class="nav-link" data-scroll-target="#questionnaire-02">Questionnaire 02</a></li>
  </ul></li>
  <li><a href="#predict-expression-from-genotype" id="toc-predict-expression-from-genotype" class="nav-link" data-scroll-target="#predict-expression-from-genotype">Predict Expression from genotype</a>
  <ul class="collapse">
  <li><a href="#optional-assess-actual-prediction-performance" id="toc-optional-assess-actual-prediction-performance" class="nav-link" data-scroll-target="#optional-assess-actual-prediction-performance">(Optional) Assess Actual Prediction Performance</a></li>
  </ul></li>
  <li><a href="#run-predixcan-association" id="toc-run-predixcan-association" class="nav-link" data-scroll-target="#run-predixcan-association">Run PrediXcan association</a>
  <ul class="collapse">
  <li><a href="#questionnaire-03" id="toc-questionnaire-03" class="nav-link" data-scroll-target="#questionnaire-03">Questionnaire 03</a></li>
  <li><a href="#looking-at-association-results" id="toc-looking-at-association-results" class="nav-link" data-scroll-target="#looking-at-association-results">Looking at Association Results</a></li>
  <li><a href="#comparing-the-estimated-effect-size-with-true-effect-size" id="toc-comparing-the-estimated-effect-size-with-true-effect-size" class="nav-link" data-scroll-target="#comparing-the-estimated-effect-size-with-true-effect-size">Comparing the Estimated Effect Size with True Effect Size</a></li>
  </ul></li>
  <li><a href="#run-summary-predixcan" id="toc-run-summary-predixcan" class="nav-link" data-scroll-target="#run-summary-predixcan">Run Summary PrediXcan</a>
  <ul class="collapse">
  <li><a href="#questionnaire-04" id="toc-questionnaire-04" class="nav-link" data-scroll-target="#questionnaire-04">Questionnaire 04</a></li>
  <li><a href="#running-s-predixcan" id="toc-running-s-predixcan" class="nav-link" data-scroll-target="#running-s-predixcan">Running S-PrediXcan</a></li>
  <li><a href="#plot-and-interpret-results" id="toc-plot-and-interpret-results" class="nav-link" data-scroll-target="#plot-and-interpret-results">Plot and Interpret Results</a></li>
  <li><a href="#run-s-predixcan-using-gene-expression-predicted-in-liver" id="toc-run-s-predixcan-using-gene-expression-predicted-in-liver" class="nav-link" data-scroll-target="#run-s-predixcan-using-gene-expression-predicted-in-liver">Run S-PrediXcan using gene expression predicted in liver</a></li>
  <li><a href="#optional-compare-zscores-in-liver-and-whole-blood." id="toc-optional-compare-zscores-in-liver-and-whole-blood." class="nav-link" data-scroll-target="#optional-compare-zscores-in-liver-and-whole-blood.">(Optional) Compare zscores in liver and whole blood.</a></li>
  <li><a href="#optional-run-multixcan" id="toc-optional-run-multixcan" class="nav-link" data-scroll-target="#optional-run-multixcan">(Optional) Run MultiXcan</a></li>
  </ul></li>
  <li><a href="#colocalization-methods-review" id="toc-colocalization-methods-review" class="nav-link" data-scroll-target="#colocalization-methods-review">Colocalization Methods (Review)</a>
  <ul class="collapse">
  <li><a href="#questionnaire-5" id="toc-questionnaire-5" class="nav-link" data-scroll-target="#questionnaire-5">Questionnaire 5</a></li>
  <li><a href="#run-colocalization" id="toc-run-colocalization" class="nav-link" data-scroll-target="#run-colocalization">Run colocalization</a></li>
  <li><a href="#load-the-genotype-to-calculate-the-ld-matrix" id="toc-load-the-genotype-to-calculate-the-ld-matrix" class="nav-link" data-scroll-target="#load-the-genotype-to-calculate-the-ld-matrix">load the genotype to calculate the ld matrix</a></li>
  <li><a href="#load-the-eqtl-and-gwas-effect-size-files" id="toc-load-the-eqtl-and-gwas-effect-size-files" class="nav-link" data-scroll-target="#load-the-eqtl-and-gwas-effect-size-files">Load the eqtl and gwas effect size files</a></li>
  <li><a href="#find-regions-with-the-strongest-signal-in-the-gwas" id="toc-find-regions-with-the-strongest-signal-in-the-gwas" class="nav-link" data-scroll-target="#find-regions-with-the-strongest-signal-in-the-gwas">Find regions with the strongest signal in the gwas</a></li>
  <li><a href="#select-a-region-to-run-coloc" id="toc-select-a-region-to-run-coloc" class="nav-link" data-scroll-target="#select-a-region-to-run-coloc">select a region to run coloc</a></li>
  <li><a href="#prepare-gwas-data-for-coloc" id="toc-prepare-gwas-data-for-coloc" class="nav-link" data-scroll-target="#prepare-gwas-data-for-coloc">Prepare gwas data for coloc</a></li>
  <li><a href="#prepare-eqtl-data-for-coloc" id="toc-prepare-eqtl-data-for-coloc" class="nav-link" data-scroll-target="#prepare-eqtl-data-for-coloc">Prepare eqtl data for coloc</a></li>
  <li><a href="#run-older-version-of-coloc-which-assumes-single-causal-variant" id="toc-run-older-version-of-coloc-which-assumes-single-causal-variant" class="nav-link" data-scroll-target="#run-older-version-of-coloc-which-assumes-single-causal-variant">run older version of coloc which assumes single causal variant</a></li>
  <li><a href="#run-coloc-allowing-multiple-causal-variants" id="toc-run-coloc-allowing-multiple-causal-variants" class="nav-link" data-scroll-target="#run-coloc-allowing-multiple-causal-variants">run coloc allowing multiple causal variants</a></li>
  </ul></li>
  <li><a href="#ctwas" id="toc-ctwas" class="nav-link" data-scroll-target="#ctwas">cTWAS</a>
  <ul class="collapse">
  <li><a href="#questionnaire-06" id="toc-questionnaire-06" class="nav-link" data-scroll-target="#questionnaire-06">Questionnaire 06</a></li>
  </ul></li>
  <li><a href="#faq-and-frequent-errors" id="toc-faq-and-frequent-errors" class="nav-link" data-scroll-target="#faq-and-frequent-errors">FAQ and frequent errors</a></li>
  <li><a href="#contributors" id="toc-contributors" class="nav-link" data-scroll-target="#contributors">Contributors</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Transcriptome QGT Training 2023</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Haky Im </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 10, 2022</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">August 9, 2023</p>
    </div>
  </div>
    
  </div>
  

</header>

<section id="goals-of-lab" class="level1">
<h1>Goals of Lab</h1>
<ul>
<li>Predict whole blood expression from genotype</li>
<li>Check how well the prediction works with GEUVADIS expression data</li>
<li>Run association between predicted expression and a phenotype</li>
<li>Calculate association between expression levels and coronary artery disease risk using s-predixcan</li>
<li>Fine-map the coronary artery disease gwas results using torus</li>
<li>Calculate colocalization probability using fastenloc</li>
<li>Run cTWAS (fine-map SNPs and genes jointly)</li>
</ul>
</section>
<section id="inital-remarks" class="level1">
<h1>Inital Remarks</h1>
<ul>
<li>We ask you to actively participate in today’s hands on activities.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Notice that we may ask you to share your screen for pedagogic purposes.</p>
</div>
</div>
<ul>
<li><p>Send Haky a private message if you really don’t want to be called to share your screen.</p></li>
<li><p>If you have any concerns about this, please ask me or one of the TAs for assistance. We are here to help you learn.</p></li>
<li><p>Open the questionnaire forms at the beginning of each section and answer the questions as you go along</p>
<ul>
<li>Name is a mandatory field. You can use your name or a pseudonymn. Just keep using the same name for each submission</li>
<li>We will ask you to submit partial set of answers so that we can get a sense of where people are</li>
</ul></li>
<li><p>Through out the lab you will see code chucks that are written with bash, eval=FALSE in place of R. These chunks are meant to be run in your Rstudio terminal and not in the Rmarkdown file itself.</p></li>
<li><p>R code chunks also have “eval=FALSE”. When you click on the green triangle, the code will run in the R console but not when we knit the document. This just happened to be more convenient for us to generate a knitted html.</p></li>
</ul>
</section>
<section id="set-up" class="level1">
<h1>Set Up</h1>
<section id="questionnaire-01" class="level2">
<h2 class="anchored" data-anchor-id="questionnaire-01">Questionnaire 01</h2>
<ul class="task-list">
<li><p><input type="checkbox">Open and start filling questionnaire 01 Preliminary questionnaire https://forms.gle/fhNJAyjx7MJTy3yt8</p></li>
<li><p><input type="checkbox">Install packages as needed</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List of packages you want to install</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>, <span class="st">"data.table"</span>, <span class="st">"BEDMatrix"</span>, <span class="st">"Rfast"</span>, <span class="st">"susieR"</span>, <span class="st">"coloc"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check and install any missing packages</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>check_and_install <span class="ot">&lt;-</span> <span class="cf">function</span>(pkg){</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(pkg, <span class="at">character.only =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(pkg, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(pkg, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the function to check and install packages</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(packages, check_and_install)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><input type="checkbox">Load Rstudio Libraries</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="do">## packages needed for susie+coloc</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BEDMatrix)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rfast)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(susieR)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coloc)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="do">##library(tidyverse)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><input type="checkbox">Navigate to starting directory</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="st">"/cloud/project/"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><input type="checkbox">activate the the imlabtools environment, which will make sure that the right version of python modules are available</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate imlabtools</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><input type="checkbox">To define some variables to access the data more easily within the R session, run the following r chunk</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">getwd</span>())</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>lab<span class="ot">=</span><span class="st">"/cloud/project/QGT-Columbia-HKI-repo/"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>CODE<span class="ot">=</span>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{lab}/code"</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{CODE}/load_data_functions.R"</span>))</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{CODE}/plotting_utils_functions.R"</span>))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>PRE<span class="ot">=</span><span class="st">"/cloud/project/QGT-Columbia-HKI-repo/box_files"</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>MODEL<span class="ot">=</span>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{PRE}/models"</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>DATA<span class="ot">=</span>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{PRE}/data"</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>RESULTS<span class="ot">=</span>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{PRE}/results"</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>METAXCAN<span class="ot">=</span>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{PRE}/repos/MetaXcan-master/software"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>FASTENLOC<span class="ot">=</span>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{PRE}/repos/fastenloc-master"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a reference table we'll use a lot throughout the lab. It contains information about the genes.</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>gencode_df <span class="ot">=</span> <span class="fu">load_gencode_df</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><input type="checkbox">check the values of the variables you just defined in R</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>MODEL</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>DATA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><input type="checkbox">define some variables to access the data more easily in the terminal. Remember we are running R code in the R console and command line code in the terminal.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PRE</span><span class="op">=</span><span class="st">"/cloud/project/QGT-Columbia-HKI-repo/box_files"</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">LAB</span><span class="op">=</span><span class="st">"/cloud/project/QGT-Columbia-HKI-repo/"</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">CODE</span><span class="op">=</span><span class="va">$LAB</span>/code</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">DATA</span><span class="op">=</span><span class="va">$PRE</span>/data</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">MODEL</span><span class="op">=</span><span class="va">$PRE</span>/models</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">RESULTS</span><span class="op">=</span><span class="va">$PRE</span>/results</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">METAXCAN</span><span class="op">=</span><span class="va">$PRE</span>/repos/MetaXcan-master/software</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><input type="checkbox">check the values of the variables you just defined</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$CODE</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$RESULTS</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="transcriptome-wide-association-review" class="level1">
<h1>Transcriptome-wide association (Review)</h1>
<p>Now we will perform a transcriptome-wide association analysis using the PrediXcan suite of tools. <img src="https://raw.githubusercontent.com/hakyimlab/QGT-Columbia-HKI/master/extras/figures/Association-Methods.png" class="img-fluid" alt="Transcriptome-wide association methods"></p>
<p>We start by predicting the expression levels of genes using the genotype data and the prediction weights and then perform an association between the predicted expression and the phenotype (denoted trait in the figure below).</p>
<p><img src="https://raw.githubusercontent.com/hakyimlab/QGT-Columbia-HKI/master/extras/figures/PrediXcan-run.png" class="img-fluid"></p>
<section id="questionnaire-02" class="level2">
<h2 class="anchored" data-anchor-id="questionnaire-02">Questionnaire 02</h2>
<ul class="task-list">
<li><input type="checkbox">Open and start filling questionnaire 02 Prediction https://forms.gle/T6kAHvFTxYfcQguW7</li>
</ul>
</section>
</section>
<section id="predict-expression-from-genotype" class="level1">
<h1>Predict Expression from genotype</h1>
<p>In this section we will predict expression of genes in whole blood using the Predict.py code in the METAXCAN folder.</p>
<ul>
<li><p>Prediction models (weights) are located in the MODEL folder. Additional models for different tissues and transcriptome studies can be downloaded from <a href="http://predictdb.org">predictdb.org</a>.</p></li>
<li><p>This run should take about one minute.</p></li>
<li><p><input type="checkbox">run the following code in the terminal.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">printf</span> <span class="st">"Predict expression\n\n"</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="va">$METAXCAN</span>/Predict.py <span class="dt">\</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>--model_db_path <span class="va">$PRE</span>/models/gtex_v8_en/en_Whole_Blood.db <span class="dt">\</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>--vcf_genotypes <span class="va">$DATA</span>/predixcan/genotype/filtered.vcf.gz <span class="dt">\</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>--vcf_mode genotyped <span class="dt">\</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>--variant_mapping <span class="va">$DATA</span>/predixcan/gtex_v8_eur_filtered_maf0.01_monoallelic_variants.txt.gz id rsid <span class="dt">\</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>--on_the_fly_mapping METADATA <span class="st">"chr{}_{}_{}_{}_b38"</span> <span class="dt">\</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>--prediction_output <span class="va">$RESULTS</span>/predixcan/Whole_Blood__predict.txt <span class="dt">\</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>--prediction_summary_output <span class="va">$RESULTS</span>/predixcan/Whole_Blood__summary.txt <span class="dt">\</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>--verbosity 9 <span class="dt">\</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>--throw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>Note we are only predicting chromosome 22 here (check by running “predicted_expression %&gt;% count(chromosome)” in the console)</p>
</blockquote>
<ul class="task-list">
<li><input type="checkbox">run following code in the console to get information on reported prediction performance.</li>
</ul>
<blockquote class="blockquote">
<p>Find additional information <a href="https://github.com/hakyimlab/MetaXcan/wiki/Individual-level-PrediXcan:-introduction,-tutorials-and-manual">in this wiki</a></p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>prediction_fp <span class="ot">=</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{RESULTS}/predixcan/Whole_Blood__predict.txt"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Read the Predict.py output into a dataframe. This function reorganizes the data and adds gene names.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>predicted_expression <span class="ot">=</span> <span class="fu">load_predicted_expression</span>(prediction_fp, gencode_df)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(predicted_expression)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="do">## read summary of prediction, number of SNPs per gene, cross validated prediction performance</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>prediction_summary <span class="ot">=</span> <span class="fu">load_prediction_summary</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{RESULTS}/predixcan/Whole_Blood__summary.txt"</span>), gencode_df)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="do">## number of genes with a prediction model</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(prediction_summary)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(prediction_summary)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="do">## how many unique genes were predicted?</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>predicted_expression <span class="sc">%&gt;%</span> .[[<span class="st">"gene_id"</span>]] <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="do">## gene expression were predicted for how many people?</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>predicted_expression <span class="sc">%&gt;%</span> .[[<span class="st">"IID"</span>]] <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"distribution of prediction performance r2"</span>)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(prediction_summary<span class="sc">$</span>pred_perf_r2)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(prediction_summary<span class="sc">$</span>pred_perf_r2)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="do">## Note: this is what the prediction trainer reported as prediction performance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="optional-assess-actual-prediction-performance" class="level2">
<h2 class="anchored" data-anchor-id="optional-assess-actual-prediction-performance">(Optional) Assess Actual Prediction Performance</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## download and read observed expression data from GEUVADIS </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="do">## from https://uchicago.box.com/s/4y7xle5l0pnq9d1fwmthe2ewhogrnlrv</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>obs_exp<span class="ot">&lt;-</span> <span class="fu">read_csv</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/predixcan/GEUVADIS.observed_df.csv.gz"</span>))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Note that the version of the ensemble id of the gene was removed</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(predicted_expression)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Q: how many genes were predicted?</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(predicted_expression<span class="sc">$</span>gene_id))</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="do">## inner join predicted expression with observed expression data (by IID and gene)</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="do">## common errors occur when ensemble id's have versions in one set and not the other set</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>fullset<span class="ot">=</span><span class="fu">inner_join</span>(predicted_expression, obs_exp, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"gene_id"</span>,<span class="st">"IID"</span>))</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate spearman correlation for all genes</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>genelist <span class="ot">=</span> <span class="fu">unique</span>(predicted_expression<span class="sc">$</span>gene_id)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>corvec <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">length</span>(genelist))</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(corvec) <span class="ot">=</span> genelist</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(gg <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(genelist))</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  ind <span class="ot">=</span> fullset<span class="sc">$</span>gene_id<span class="sc">==</span>genelist[gg]</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  corvec[gg] <span class="ot">=</span> <span class="fu">cor</span>(fullset<span class="sc">$</span>predicted_expression[ind], fullset<span class="sc">$</span>observed_expression[ind])</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="do">## what's the best performing gene?</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="do">## plot the histogram of the prediction performance</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(corvec)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="do">## list the top 10 best performing genes</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">sort</span>(corvec,<span class="at">decreasing =</span> <span class="cn">TRUE</span>),<span class="dv">2</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(<span class="fu">sort</span>(corvec,<span class="at">decreasing =</span> <span class="cn">TRUE</span>),<span class="dv">2</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="do">## plot the correlation of the top 2 best performing genes bottom 2</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>geneid <span class="ot">=</span> <span class="st">"ENSG00000100376"</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>genename <span class="ot">=</span> gencode_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> .[[<span class="st">"gene_name"</span>]]</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>fullset <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(observed_expression, predicted_expression))<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="fu">paste</span>(genename, <span class="st">"-"</span>,geneid))</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>geneid <span class="ot">=</span> <span class="st">"ENSG00000075234"</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>genename <span class="ot">=</span> gencode_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> .[[<span class="st">"gene_name"</span>]]</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>fullset <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(observed_expression, predicted_expression))<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="fu">paste</span>(genename, <span class="st">"-"</span>, geneid))</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>geneid <span class="ot">=</span> <span class="st">"ENSG00000070371"</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>genename <span class="ot">=</span> gencode_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> .[[<span class="st">"gene_name"</span>]]</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>fullset <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(observed_expression, predicted_expression))<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="fu">paste</span>(genename, <span class="st">"-"</span>, geneid))</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>geneid <span class="ot">=</span> <span class="st">"ENSG00000184164"</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>genename <span class="ot">=</span> gencode_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> .[[<span class="st">"gene_name"</span>]]</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>fullset <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(observed_expression, predicted_expression))<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="fu">paste</span>(genename, <span class="st">"-"</span>, geneid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="run-predixcan-association" class="level1">
<h1>Run PrediXcan association</h1>
<section id="questionnaire-03" class="level2">
<h2 class="anchored" data-anchor-id="questionnaire-03">Questionnaire 03</h2>
<ul class="task-list">
<li><input type="checkbox">Open and start filling questionnaire 03 PrediXcan https://forms.gle/3H319knWbLgnynNs9</li>
</ul>
<p>We are going to use a simulated phenotype for which only UPK3A has an effect on the phenotype (<span class="math inline">\(\beta=-0.9887378\)</span>)</p>
<p><span class="math inline">\(Y = \sum_k T_k \beta_k + \epsilon\)</span></p>
<p>with random effects <span class="math inline">\(\beta_k \sim (1-\pi)\cdot \delta_0 + \pi\cdot N(0,1)\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PHENO</span><span class="op">=</span><span class="st">"sim.spike_n_slab_0.01_pve0.1"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="bu">printf</span> <span class="st">"association\n\n"</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="va">$METAXCAN</span>/PrediXcanAssociation.py <span class="dt">\</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>--expression_file <span class="va">$RESULTS</span>/predixcan/Whole_Blood__predict.txt <span class="dt">\</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>--input_phenos_file <span class="va">$DATA</span>/predixcan/phenotype/<span class="va">$PHENO</span>.txt <span class="dt">\</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>--input_phenos_column pheno <span class="dt">\</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>--output <span class="va">$RESULTS</span>/predixcan/<span class="va">$PHENO</span>/Whole_Blood__association.txt <span class="dt">\</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>--verbosity 9 <span class="dt">\</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>--throw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>More predicted phenotypes can be found in $DATA/predixcan/phenotype/. The naming of the phenotypes provides information about the genetic architecture: the number after pve is the proportion of variance of Y explained by the genetic component of expression. The number after spike_n_slab represents the probability that a gene is causal π (i.e.&nbsp;prob β≠0)</p>
</section>
<section id="looking-at-association-results" class="level2">
<h2 class="anchored" data-anchor-id="looking-at-association-results">Looking at Association Results</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## read association results</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>PHENO<span class="ot">=</span><span class="st">"sim.spike_n_slab_0.01_pve0.1"</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>predixcan_association <span class="ot">=</span> <span class="fu">load_predixcan_association</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{RESULTS}/predixcan/{PHENO}/Whole_Blood__association.txt"</span>), gencode_df)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="do">## take a look at the results</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(predixcan_association)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>predixcan_association <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> <span class="fu">select</span>(gene_name,effect,se,pvalue,gene) <span class="sc">%&gt;%</span> head</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>predixcan_association <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(pvalue)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins=</span><span class="dv">10</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="do">## compare distribution against the null (uniform)</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="fu">gg_qqplot</span>(predixcan_association<span class="sc">$</span>pvalue, <span class="at">max_yval =</span> <span class="dv">40</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="comparing-the-estimated-effect-size-with-true-effect-size" class="level2">
<h2 class="anchored" data-anchor-id="comparing-the-estimated-effect-size-with-true-effect-size">Comparing the Estimated Effect Size with True Effect Size</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>truebetas <span class="ot">=</span> <span class="fu">load_truebetas</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/predixcan/phenotype/gene-effects/{PHENO}.txt"</span>), gencode_df)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>betas <span class="ot">=</span> (predixcan_association <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>               <span class="fu">inner_join</span>(truebetas,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"gene"</span><span class="ot">=</span><span class="st">"gene_id"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>               <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">'estimated_beta'</span><span class="ot">=</span><span class="st">'effect'</span>, </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'true_beta'</span><span class="ot">=</span><span class="st">'effect_size'</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'pvalue'</span>, </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'gene_id'</span><span class="ot">=</span><span class="st">'gene'</span>, </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'gene_name'</span><span class="ot">=</span><span class="st">'gene_name.x'</span>, </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'region_id'</span><span class="ot">=</span><span class="st">'region_id.x'</span>)))</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>betas <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> <span class="fu">select</span>(gene_name,estimated_beta,true_beta,pvalue) <span class="sc">%&gt;%</span> head</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="do">## do you see examples of potential LD contamination?</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>betas <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">causal=</span> true_beta<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(estimated_beta, true_beta,<span class="at">col=</span>causal))<span class="sc">+</span><span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.6</span>,<span class="at">size=</span><span class="dv">5</span>)<span class="sc">+</span><span class="fu">geom_abline</span>()<span class="sc">+</span><span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>UPK3A is the causal gene and has the most significant pvalue. RIBC2 is also significantly associated but has no causal role (we know because we simulated the phenotype that way). Why?</p>
</blockquote>
<p>Hint: correlation between the genes</p>
</section>
</section>
<section id="run-summary-predixcan" class="level1">
<h1>Run Summary PrediXcan</h1>
<p>Now we will use the summary results from a GWAS of coronary artery disease to calculate the association between the genetic component of the expression of genes and coronary artery disease risk. We will use the SPrediXcan.py.</p>
<p><img src="https://uchicago.box.com/shared/static/m45nnkeskzh88ifnv8td5e3fntdfzhjs.png" class="img-fluid"></p>
<p>The GWAS results (harmonized and imputed) for coronary artery disease are available in $PRE/spredixcan/data/</p>
<section id="questionnaire-04" class="level2">
<h2 class="anchored" data-anchor-id="questionnaire-04">Questionnaire 04</h2>
<ul class="task-list">
<li><input type="checkbox">Open and start filling questionnaire 04 S-PrediXcan https://forms.gle/xJs2U66cnrqdb5cj6</li>
</ul>
</section>
<section id="running-s-predixcan" class="level2">
<h2 class="anchored" data-anchor-id="running-s-predixcan">Running S-PrediXcan</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="va">$METAXCAN</span>/SPrediXcan.py <span class="dt">\</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>--gwas_file  <span class="va">$DATA</span>/spredixcan/imputed_CARDIoGRAM_C4D_CAD_ADDITIVE.txt.gz <span class="dt">\</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>--snp_column panel_variant_id <span class="dt">\</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>--effect_allele_column effect_allele <span class="dt">\</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>--non_effect_allele_column non_effect_allele <span class="dt">\</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>--zscore_column zscore <span class="dt">\</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>--model_db_path <span class="va">$MODEL</span>/gtex_v8_mashr/mashr_Whole_Blood.db <span class="dt">\</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>--covariance <span class="va">$MODEL</span>/gtex_v8_mashr/mashr_Whole_Blood.txt.gz <span class="dt">\</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>--keep_non_rsid <span class="dt">\</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>--additional_output <span class="dt">\</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>--model_db_snp_key varID <span class="dt">\</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>--throw <span class="dt">\</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>--output_file <span class="va">$RESULTS</span>/spredixcan/eqtl/CARDIoGRAM_C4D_CAD_ADDITIVE__PM__Whole_Blood.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>We can run the full genome because the summary statistics based PrediXcan is much faster than individual level one.</p>
</blockquote>
</section>
<section id="plot-and-interpret-results" class="level2">
<h2 class="anchored" data-anchor-id="plot-and-interpret-results">Plot and Interpret Results</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>spredixcan_association <span class="ot">=</span> <span class="fu">load_spredixcan_association</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{RESULTS}/spredixcan/eqtl/CARDIoGRAM_C4D_CAD_ADDITIVE__PM__Whole_Blood.csv"</span>), gencode_df)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(spredixcan_association)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>spredixcan_association <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> head</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>spredixcan_association <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(pvalue)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins=</span><span class="dv">20</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">gg_qqplot</span>(spredixcan_association<span class="sc">$</span>pvalue)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><em>Question:</em> SORT1, considered to be a causal gene for LDL cholesterol and as a consequence of coronary artery disease, is not found here. Why?</p></li>
<li><p><input type="checkbox">check whether SORT1 is expressed in whole blood <a href="https://gtexportal.org/home/gene/SORT1">GTEx portal</a></p></li>
<li><p><input type="checkbox">check whether SORT1 has eQTL in whole blood <a href="https://gtexportal.org/home/gene/SORT1">GTEx portal</a></p></li>
</ul>
</section>
<section id="run-s-predixcan-using-gene-expression-predicted-in-liver" class="level2">
<h2 class="anchored" data-anchor-id="run-s-predixcan-using-gene-expression-predicted-in-liver">Run S-PrediXcan using gene expression predicted in liver</h2>
<p>-[] Run s-predixcan with liver model, do you find SORT1? Is it significant?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#loction Liver models </span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#/cloud/project/QGT-Columbia-HKI-repo/box_files/models/gtex_v8_mashr/</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="va">$METAXCAN</span>/SPrediXcan.py <span class="dt">\</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>--gwas_file  <span class="va">$DATA</span>/spredixcan/imputed_CARDIoGRAM_C4D_CAD_ADDITIVE.txt.gz <span class="dt">\</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>--snp_column panel_variant_id <span class="dt">\</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>--effect_allele_column effect_allele <span class="dt">\</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>--non_effect_allele_column non_effect_allele <span class="dt">\</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>--zscore_column zscore <span class="dt">\</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>--model_db_path <span class="va">$MODEL</span>/gtex_v8_mashr/mashr_Liver.db <span class="dt">\</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>--covariance <span class="va">$MODEL</span>/gtex_v8_mashr/mashr_Liver.txt.gz <span class="dt">\</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>--keep_non_rsid <span class="dt">\</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>--additional_output <span class="dt">\</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>--model_db_snp_key varID <span class="dt">\</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>--throw <span class="dt">\</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>--output_file <span class="va">$RESULTS</span>/spredixcan/eqtl/CARDIoGRAM_C4D_CAD_ADDITIVE__PM__Liver.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>spredixcan_association_L<span class="ot">=</span> <span class="fu">load_spredixcan_association</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{RESULTS}/spredixcan/eqtl/CARDIoGRAM_C4D_CAD_ADDITIVE__PM__Liver.csv"</span>), gencode_df)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(spredixcan_association_L)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>spredixcan_association_L <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> head</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>spredixcan_association_L <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(pvalue)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins=</span><span class="dv">20</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">gg_qqplot</span>(spredixcan_association_L<span class="sc">$</span>pvalue)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>col_order<span class="ot">=</span> <span class="fu">c</span>(<span class="st">"gene_name"</span>,<span class="st">"gene"</span>,<span class="st">"zscore"</span>,<span class="st">"effect_size"</span>,<span class="st">"pvalue"</span>,<span class="st">"var_g"</span>,<span class="st">"pred_perf_r2"</span>, <span class="st">"pred_perf_pval"</span>,<span class="st">"pred_perf_qval"</span>, <span class="st">"n_snps_used"</span>, <span class="st">"n_snps_in_cov"</span>, <span class="st">"n_snps_in_model"</span>,<span class="st">"best_gwas_p"</span>,<span class="st">"largest_weight"</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>spredixcan_association_L <span class="ot">&lt;-</span> spredixcan_association_L[, col_order]</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(spredixcan_association_L, gene_name<span class="sc">==</span><span class="st">"SORT1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="optional-compare-zscores-in-liver-and-whole-blood." class="level2">
<h2 class="anchored" data-anchor-id="optional-compare-zscores-in-liver-and-whole-blood.">(Optional) Compare zscores in liver and whole blood.</h2>
<blockquote class="blockquote">
<p>Recall that zscore is the effect size divided by the standard error</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>spredixcan_association_L<span class="ot">=</span><span class="fu">rename</span>(spredixcan_association_L, <span class="at">zscore_liver =</span> <span class="st">"zscore"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(spredixcan_association_L)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>test<span class="ot">=</span><span class="fu">left_join</span>(spredixcan_association, spredixcan_association_L, <span class="at">by=</span><span class="st">"gene_name"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>test<span class="ot">=</span><span class="fu">select</span>(test,<span class="st">"gene_name"</span>,<span class="st">"zscore"</span>,<span class="st">"zscore_liver"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>test <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(zscore_liver) <span class="sc">%&gt;%</span> head</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>test <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">zscore_WB=</span>zscore) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(zscore_WB,zscore_liver)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">3</span>,<span class="at">alpha=</span>.<span class="dv">6</span>) <span class="sc">+</span> <span class="fu">geom_abline</span>()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="do">## S-PrediXcan association in liver and whole blood are significantly correlated</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>(test<span class="sc">$</span>zscore,test<span class="sc">$</span>zscore_liver)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="optional-run-multixcan" class="level2">
<h2 class="anchored" data-anchor-id="optional-run-multixcan">(Optional) Run MultiXcan</h2>
<ul>
<li><p>multixcan aggregates information across multiple tissues to boost the power to detect association. It was developed movivated by the fact that eQTLs are shared across multiple tissues, i.e.&nbsp;many genetic variants that regulate expression are common across tissues.</p></li>
<li><p>before you run multixcan ensure you have run s-predixcan for all the tissues you want to multixcan. In this tutorial we have two tissues (liver and whole blood), ensure you have run s-predixcan with the two tissues before running multixcan.</p></li>
<li><p>One thing to note is to ensure similar naming pattern for the output files. This is to ensure the files are captured correctly when running multixcan’s filter.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="va">$METAXCAN</span>/SMulTiXcan.py <span class="dt">\</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>--models_folder <span class="va">$MODEL</span>/gtex_v8_mashr <span class="dt">\</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>--models_name_pattern <span class="st">"mashr_(.*).db"</span> <span class="dt">\</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>--snp_covariance <span class="va">$MODEL</span>/gtex_v8_expression_mashr_snp_smultixcan_covariance.txt.gz <span class="dt">\</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>--metaxcan_folder <span class="va">$RESULTS</span>/spredixcan/eqtl/ <span class="dt">\</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>--metaxcan_filter <span class="st">"CARDIoGRAM_C4D_CAD_ADDITIVE__PM__(.*).csv"</span> <span class="dt">\</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>--metaxcan_file_name_parse_pattern <span class="st">"(.*)__PM__(.*).csv"</span> <span class="dt">\</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>--gwas_file <span class="va">$DATA</span>/spredixcan/imputed_CARDIoGRAM_C4D_CAD_ADDITIVE.txt.gz <span class="dt">\</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>--snp_column panel_variant_id <span class="at">--effect_allele_column</span> effect_allele <span class="at">--non_effect_allele_column</span> non_effect_allele <span class="at">--zscore_column</span> zscore <span class="at">--keep_non_rsid</span> <span class="at">--model_db_snp_key</span> varID <span class="dt">\</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>--cutoff_condition_number 30 <span class="dt">\</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>--verbosity 9 <span class="dt">\</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>--throw <span class="dt">\</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>--output <span class="va">$RESULTS</span>/smultixcan/eqtl/CARDIoGRAM_C4D_CAD_ADDITIVE_smultixcan.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="colocalization-methods-review" class="level1">
<h1>Colocalization Methods (Review)</h1>
<p>Colocalization methods seek to estimate the probability that the complex trait and expression causal variants are the same. We favor methods that calculate the probability of causality for each trait (posterior inclusion probability), called fine-mapping methods. Here we use susie for fine-mapping and coloc for colocalization.</p>
<p><img src="https://raw.githubusercontent.com/hakyimlab/QGT-Columbia-HKI/master/extras/figures/colocalization-run.png" class="img-fluid"></p>
<section id="questionnaire-5" class="level2">
<h2 class="anchored" data-anchor-id="questionnaire-5">Questionnaire 5</h2>
<ul class="task-list">
<li><input type="checkbox">Open and start filling questionnaire 05 Colocalization https://forms.gle/NfH2MSdy4UyJzGAp7</li>
</ul>
</section>
<section id="run-colocalization" class="level2">
<h2 class="anchored" data-anchor-id="run-colocalization">Run colocalization</h2>
<p>When you use coloc on your own data, you may want to check out coloc’s documentation, with good advice and tips on avoiding common mistakes https://cran.r-project.org/web/packages/coloc/vignettes</p>
<p>Due to time constraints, we will run one region and one gene only</p>
<ol type="1">
<li>Finemap GWAS of CAD</li>
<li>Finemap eQTL of SORT1</li>
</ol>
<p>For finemapping, we need the summary statistics (effect size, standard errors, etc) and the correlation between SNPs (LD matrix)</p>
</section>
<section id="load-the-genotype-to-calculate-the-ld-matrix" class="level2">
<h2 class="anchored" data-anchor-id="load-the-genotype-to-calculate-the-ld-matrix">load the genotype to calculate the ld matrix</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the genotype to calculate the ld matrix</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>X_mat <span class="ot">&lt;-</span> <span class="fu">BEDMatrix</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/colocalization/geuvadis_chr1"</span>))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(X_mat) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">_.*"</span>, <span class="st">""</span>,<span class="fu">colnames</span>(X_mat))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(X_mat) <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">colnames</span>(X_mat),<span class="st">":"</span>,<span class="st">"_"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>snp_info <span class="ot">&lt;-</span> <span class="fu">fread</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/colocalization/geuvadis_chr1.bim"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setnames</span>(., <span class="fu">colnames</span>(.), <span class="fu">c</span>(<span class="st">"chr"</span>, <span class="st">"snp"</span>, <span class="st">"cm"</span>, <span class="st">"pos"</span>, <span class="st">"alt"</span>, <span class="st">"ref"</span>)) </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>snp_info<span class="sc">$</span>snp <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(snp_info<span class="sc">$</span>snp,<span class="st">":"</span>,<span class="st">"_"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-the-eqtl-and-gwas-effect-size-files" class="level2">
<h2 class="anchored" data-anchor-id="load-the-eqtl-and-gwas-effect-size-files">Load the eqtl and gwas effect size files</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the eqtl effect sizes</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>gene_ss <span class="ot">&lt;-</span> <span class="fu">fread</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/colocalization/Liver_chr1.txt"</span>))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># load gwas effect sizes</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>gwas <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/spredixcan/imputed_CARDIoGRAM_C4D_CAD_ADDITIVE.txt.gz"</span>))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># filter to select genome wide significant snps at 5 × 10−8</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>filtered_regions <span class="ot">&lt;-</span> gwas <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(pvalue <span class="sc">&lt;</span> <span class="fl">5e-8</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># load the ld block</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>ldblocks <span class="ot">&lt;-</span><span class="fu">read_tsv</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/spredixcan/eur_ld.hg38.txt.gz"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="find-regions-with-the-strongest-signal-in-the-gwas" class="level2">
<h2 class="anchored" data-anchor-id="find-regions-with-the-strongest-signal-in-the-gwas">Find regions with the strongest signal in the gwas</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the loci where the significant snps are located</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(filtered_regions)){</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract genename, start and end</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  variant_id <span class="ot">&lt;-</span> <span class="fu">as.character</span>(filtered_regions[n,<span class="st">"variant_id"</span>])</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  variant_chr <span class="ot">&lt;-</span> <span class="fu">as.character</span>(filtered_regions[n,<span class="st">"chromosome"</span>])</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  variant_pos <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(filtered_regions[n,<span class="st">"position"</span>])</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#gene_end &lt;- as.numeric(genes[n,"end"])</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  locus <span class="ot">&lt;-</span> ldblocks <span class="sc">%&gt;%</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(chr <span class="sc">==</span> variant_chr) <span class="sc">%&gt;%</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(variant_pos <span class="sc">&gt;=</span> start <span class="sc">&amp;</span> variant_pos <span class="sc">&lt;</span> stop) <span class="sc">%&gt;%</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">locus_name =</span> <span class="fu">paste0</span>(chr,<span class="st">"_"</span>,start,<span class="st">"_"</span>,stop)) <span class="sc">%&gt;%</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">locus_start=</span>start,<span class="at">locus_end=</span>stop) <span class="sc">%&gt;%</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">variant_id =</span> variant_id, <span class="at">position=</span>variant_pos)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a data frame with info</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">'all_loci'</span>) <span class="sc">&amp;&amp;</span> <span class="fu">is.data.frame</span>(<span class="fu">get</span>(<span class="st">'all_loci'</span>))) {</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    all_loci <span class="ot">&lt;-</span> <span class="fu">rbind</span>(all_loci,locus)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    all_loci <span class="ot">&lt;-</span> locus</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co"># select uniq loci</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>d_loci <span class="ot">&lt;-</span> all_loci <span class="sc">%&gt;%</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(locus_name,chr,locus_start,locus_end) <span class="sc">%&gt;%</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="select-a-region-to-run-coloc" class="level2">
<h2 class="anchored" data-anchor-id="select-a-region-to-run-coloc">select a region to run coloc</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select regions to fine map. we are going to use regions in chromosome 1</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>uniq_loci <span class="ot">&lt;-</span> d_loci <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="st">"chr1"</span> <span class="sc">==</span> chr)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">3</span> <span class="co"># chr1_107867043_109761309 region</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># extract information</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>l_chr <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(uniq_loci[n,<span class="st">"chr"</span>],<span class="st">"chr"</span>))</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>s_chr <span class="ot">=</span> uniq_loci[n,]<span class="sc">$</span>chr</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>l_start <span class="ot">=</span> uniq_loci[n,]<span class="sc">$</span>locus_start</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>l_stop <span class="ot">=</span> uniq_loci[n,]<span class="sc">$</span>locus_end</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>l_name <span class="ot">=</span> uniq_loci[n,]<span class="sc">$</span>locus_name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prepare-gwas-data-for-coloc" class="level2">
<h2 class="anchored" data-anchor-id="prepare-gwas-data-for-coloc">Prepare gwas data for coloc</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># select snps for the region from the summary stats</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> gwas <span class="sc">%&gt;%</span> </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(chromosome <span class="sc">==</span> s_chr) <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(position <span class="sc">&gt;=</span> l_start <span class="sc">&amp;</span> position <span class="sc">&lt;=</span> l_stop) <span class="sc">%&gt;%</span> </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span> <span class="fu">is.na</span>(effect_size))</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># find the snps in the genotype to calculate the correlation</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>g.snps <span class="ot">&lt;-</span> ss <span class="sc">%&gt;%</span> <span class="fu">inner_join</span>(snp_info <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">chr =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"chr{chr}"</span>)), </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">by=</span><span class="fu">c</span>(<span class="st">"chromosome"</span> <span class="ot">=</span> <span class="st">"chr"</span>,<span class="st">"panel_variant_id"</span> <span class="ot">=</span> <span class="st">"snp"</span>))</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co"># select genotype to calculate correlation</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co">#f_mat &lt;- X_mat[,g.snps$snp]</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>f_mat <span class="ot">&lt;-</span> X_mat[,g.snps<span class="sc">$</span>panel_variant_id]</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate corr</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> <span class="fu">cora</span>(f_mat) <span class="co"># the package is for speed</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="do">## clean up</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(f_mat)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>ff <span class="ot">&lt;-</span> g.snps <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span> <span class="fu">is.na</span>(effect_size)) <span class="sc">%&gt;%</span> <span class="co">#select(-snp) %&gt;% </span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">snp=</span>panel_variant_id,<span class="at">beta=</span>effect_size) <span class="sc">%&gt;%</span> </span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">varbeta =</span> standard_error<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(beta,varbeta,snp,position) <span class="sc">%&gt;%</span> <span class="fu">as.list</span>()</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>ff<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">"cc"</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>ff<span class="sc">$</span>sdY <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>ff<span class="sc">$</span>LD <span class="ot">=</span> R</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>ff<span class="sc">$</span>N <span class="ot">=</span> <span class="dv">184305</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="do">## check the data (NULL means it's fine)</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="fu">check_dataset</span>(ff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="prepare-eqtl-data-for-coloc" class="level2">
<h2 class="anchored" data-anchor-id="prepare-eqtl-data-for-coloc">Prepare eqtl data for coloc</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Using SORT1 gene and liver tissue</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>gene <span class="ot">&lt;-</span> gene_ss <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(gene_id <span class="sc">==</span> <span class="st">"ENSG00000134243.11"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">snp =</span> variant_id,<span class="at">beta =</span> slope, <span class="at">MAF =</span> maf,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">pvalue =</span> pval_nominal) <span class="sc">%&gt;%</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">varbeta =</span> slope_se<span class="sc">^</span><span class="dv">2</span>, <span class="at">name =</span> snp) <span class="sc">%&gt;%</span> </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span> <span class="fu">is.na</span>(varbeta)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(name, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"chr"</span>, <span class="st">"position"</span>,<span class="st">"ref"</span>,<span class="st">"alt"</span>,<span class="st">"build"</span>),<span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate the ld matrix</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="do">### get the snps</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>gene.snps <span class="ot">&lt;-</span> gene <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">position =</span> <span class="fu">as.integer</span>(position)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(snp_info <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">chr =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"chr{chr}"</span>)), </span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>                              <span class="at">by=</span><span class="fu">c</span>(<span class="st">"chr"</span> <span class="ot">=</span> <span class="st">"chr"</span>,<span class="st">"snp"</span> <span class="ot">=</span> <span class="st">"snp"</span>))</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co"># select genotype to calculate correlation</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>g_mat <span class="ot">&lt;-</span> X_mat[,gene.snps<span class="sc">$</span>snp]</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate corr</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>g.R <span class="ot">=</span> <span class="fu">cora</span>(g_mat)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="co"># clean up</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(g_mat)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="co"># format data for coloc</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span> gene <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(snp <span class="sc">%in%</span> gene.snps<span class="sc">$</span>snp) <span class="sc">%&gt;%</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">position =</span> <span class="fu">as.integer</span>(position)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(beta,varbeta,snp,position,MAF, pvalue) <span class="sc">%&gt;%</span> <span class="fu">as.list</span>()</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>gg<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">"quant"</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>gg<span class="sc">$</span>LD <span class="ot">=</span> g.R</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>gg<span class="sc">$</span>N <span class="ot">=</span> <span class="dv">208</span> <span class="co"># 670 for blood</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="do">## check the data</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a><span class="fu">check_dataset</span>(gg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="run-older-version-of-coloc-which-assumes-single-causal-variant" class="level2">
<h2 class="anchored" data-anchor-id="run-older-version-of-coloc-which-assumes-single-causal-variant">run older version of coloc which assumes single causal variant</h2>
<p><em>coloc.abf</em> makes the simplifying assumption that each trait has at most one causal variant in the region under consideration</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>my.res <span class="ot">&lt;-</span> <span class="fu">coloc.abf</span>(<span class="at">dataset1=</span>ff, <span class="at">dataset2=</span>gg)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sensitivity</span>(my.res,<span class="st">"H4 &gt; 0.9"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="run-coloc-allowing-multiple-causal-variants" class="level2">
<h2 class="anchored" data-anchor-id="run-coloc-allowing-multiple-causal-variants">run coloc allowing multiple causal variants</h2>
<p>Multiple causal variants, using SuSiE to separate the signals</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run susie fine maooing</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>S3 <span class="ot">=</span> <span class="fu">runsusie</span>(ff)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>S4 <span class="ot">=</span> <span class="fu">runsusie</span>(gg)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(S3)</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Run coloc</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>susie.res<span class="ot">=</span><span class="fu">coloc.susie</span>(S3,S4)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(susie.res<span class="sc">$</span>summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>SuSiE can take a while to run on larger datasets, so it is best to run once per dataset with the =runsusie= function, store the results and feed those into subsequent analyses.</p>
<p>plot the coloc result with the sensitivity function because weird effects are much easier to understand visually</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sensitivity</span>(susie.res,<span class="st">"H4 &gt; 0.9"</span>,<span class="at">row=</span><span class="dv">1</span>,<span class="at">dataset1=</span>ff,<span class="at">dataset2=</span>gg,)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="ctwas" class="level1">
<h1>cTWAS</h1>
<p>cTWAS stands for causal TWAS and seeks to calculate the posterior inclusion probability of genes and SNPs in a given region to be causal. It’s a modification of SUSIER that adds predicted gene expression levels in addition to SNPs in the analysis. It is not yet published, but the authors (Siming Zhao, Wesley Crouse, Matthew Stephens et al) have shared a vignette with us to try it out.</p>
<blockquote class="blockquote">
<p>Thank you, Wes, for creating this portion of the lab!</p>
</blockquote>
<section id="questionnaire-06" class="level2">
<h2 class="anchored" data-anchor-id="questionnaire-06">Questionnaire 06</h2>
<ul class="task-list">
<li><input type="checkbox">Open and start filling out questionnaire 06 cTWAS https://forms.gle/A4evWkbhR7cXLy36A</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("R.utils")</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("remotes")</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">#remotes::install_github("simingz/ctwas", ref = "develop")</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ctwas)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">#get positions for region of interest (SORT1/PSRC1 locus)</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>region <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">strsplit</span>(spredixcan_association<span class="sc">$</span>region_id[spredixcan_association<span class="sc">$</span>gene_name<span class="sc">==</span><span class="st">"PSRC1"</span>], <span class="st">"_"</span>))</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>chr <span class="ot">&lt;-</span> region[<span class="dv">2</span>]</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(region[<span class="dv">3</span>])</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>end <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(region[<span class="dv">4</span>])</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co">#format summary statistics (and subset to variants in region to save memory)</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>z_snp <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/spredixcan/imputed_CARDIoGRAM_C4D_CAD_ADDITIVE.txt.gz"</span>), <span class="at">select=</span><span class="fu">c</span>(<span class="st">"chromosome"</span>, <span class="st">"position"</span>, <span class="st">"variant_id"</span>, <span class="st">"effect_allele"</span>, <span class="st">"non_effect_allele"</span>, <span class="st">"zscore"</span>, <span class="st">"sample_size"</span>))</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>z_snp <span class="ot">&lt;-</span> z_snp[z_snp<span class="sc">$</span>chromosome<span class="sc">==</span>chr <span class="sc">&amp;</span> z_snp<span class="sc">$</span>position <span class="sc">&gt;=</span> start <span class="sc">&amp;</span> z_snp<span class="sc">$</span>position <span class="sc">&lt;=</span> end,]</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>z_snp <span class="ot">&lt;-</span> z_snp[<span class="sc">!</span><span class="fu">is.na</span>(z_snp<span class="sc">$</span>variant_id),<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(z_snp) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"A1"</span>, <span class="st">"A2"</span>, <span class="st">"z"</span>, <span class="st">"ss"</span>)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="co">#specify directories for LD matrices and weights</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>ld_R_dir <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/cTWAS/LD_matrices"</span>)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>weight <span class="ot">&lt;-</span>  glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{MODEL}/gtex_v8_mashr/mashr_Liver.db"</span>)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="co">#specify output locations and names for cTWAS</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>outputdir <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/cTWAS/results/"</span>)</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>outname.e <span class="ot">&lt;-</span> <span class="st">"CARDIoGRAM_Liver_expr"</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>outname <span class="ot">&lt;-</span> <span class="st">"CARDIoGRAM_Liver_ctwas"</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a><span class="co">#impute gene z scores using cTWAS and save the results</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a><span class="do">##################################</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: we are skipping this step and using the precomputed values </span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="do">## takes ~10 minutes</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a><span class="do">##################################</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a><span class="co"># ctwas_imputation &lt;- impute_expr_z(z_snp=z_snp, weight=weight, ld_R_dir=ld_R_dir, outputdir=outputdir, outname=outname.e, harmonize_z=F, harmonize_wgt=F)</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="co"># save(ctwas_imputation, file = paste0(outputdir, outname.e, "_output.Rd"))</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(outputdir, outname.e, <span class="st">"_output.Rd"</span>))</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>z_gene <span class="ot">&lt;-</span> ctwas_imputation<span class="sc">$</span>z_gene</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>ld_exprfs <span class="ot">&lt;-</span> ctwas_imputation<span class="sc">$</span>ld_exprfs</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>z_snp <span class="ot">&lt;-</span> ctwas_imputation<span class="sc">$</span>z_snp</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a><span class="co">#make custom region file for single region</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>ld_regions_custom <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">"chr"</span> <span class="ot">=</span> chr, <span class="st">"start"</span> <span class="ot">=</span> start, <span class="st">"stop"</span> <span class="ot">=</span> end)</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(ld_regions_custom, </span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>            <span class="at">file=</span> <span class="fu">paste0</span>(outputdir, <span class="st">"ld_regions_custom.txt"</span>),</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>            <span class="at">row.names=</span>F, <span class="at">col.names=</span>T, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">quote =</span> F)</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>ld_regions_custom <span class="ot">&lt;-</span> <span class="fu">paste0</span>(outputdir, <span class="st">"ld_regions_custom.txt"</span>)</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a><span class="co">#run cTWAS with pre-specified prior parameters at a single locus</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a><span class="co">#estimating prior requires genome-wide data, too slow for demonstration</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a><span class="co">#prior is 1% inclusion for genes and is 100x more likely than SNPs</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a><span class="co">#prior assumes genes have larger effect size than SNPs, in reasonable range for data we've looked at</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a><span class="fu">ctwas_rss</span>(<span class="at">z_gene=</span>z_gene, <span class="at">z_snp=</span>z_snp, <span class="at">ld_exprfs=</span>ld_exprfs, <span class="at">ld_R_dir =</span> ld_R_dir, <span class="at">ld_regions_custom=</span>ld_regions_custom, <span class="at">outputdir =</span> outputdir, <span class="at">outname =</span> outname, <span class="at">thin =</span> <span class="fl">0.01</span>,</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>          <span class="at">estimate_group_prior =</span> F,</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>          <span class="at">estimate_group_prior_var =</span> F,</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>          <span class="at">group_prior=</span><span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.0001</span>),</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>          <span class="at">group_prior_var=</span><span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">25</span>))</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a><span class="co">#load results</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>ctwas_results <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="fu">paste0</span>(outputdir,outname,<span class="st">".susieIrss.txt"</span>))</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a><span class="co">#merge gene names into the results</span></span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>sqlite <span class="ot">&lt;-</span> RSQLite<span class="sc">::</span><span class="fu">dbDriver</span>(<span class="st">"SQLite"</span>)</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>db <span class="ot">=</span> RSQLite<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite, weight)</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="cf">function</span>(...) RSQLite<span class="sc">::</span><span class="fu">dbGetQuery</span>(db, ...)</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>extra_table <span class="ot">&lt;-</span> <span class="fu">query</span>(<span class="st">"select * from extra"</span>)</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>RSQLite<span class="sc">::</span><span class="fu">dbDisconnect</span>(db)</span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>ctwas_results<span class="sc">$</span>genename <span class="ot">&lt;-</span> extra_table<span class="sc">$</span>genename[<span class="fu">match</span>(ctwas_results<span class="sc">$</span>id, extra_table<span class="sc">$</span>gene)]</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a><span class="co">#show results with highest PIPs</span></span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>col_order_2<span class="ot">=</span> <span class="fu">c</span>(<span class="st">"genename"</span>, <span class="st">"chrom"</span>, <span class="st">"id"</span>, <span class="st">"pos"</span>, <span class="st">"type"</span>, <span class="st">"region_tag1"</span>, <span class="st">"region_tag2"</span>, <span class="st">"cs_index"</span>, <span class="st">"susie_pip"</span> , <span class="st">"mu2"</span>)</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>ctwas_results <span class="ot">&lt;-</span> ctwas_results[, ..col_order_2]</span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ctwas_results[<span class="fu">order</span>(<span class="sc">-</span>ctwas_results<span class="sc">$</span>susie_pip),])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="faq-and-frequent-errors" class="level1">
<h1>FAQ and frequent errors</h1>
<ul>
<li><p>conda environment may not load correctly after resuming the project in Rstudio cloud</p></li>
<li><p>when inner joining by ensemble id of genes, make sure that both datasets have either the same versions or remove versions</p></li>
</ul>
</section>
<section id="contributors" class="level1">
<h1>Contributors</h1>
<ul>
<li>Festus Nyasimi</li>
<li>Margaret Perry</li>
<li>Wes Crouse</li>
<li>Owen Melia</li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Transcriptome QGT Training 2023</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Haky Im</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> '2022-06-10'</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="an">date-modified:</span><span class="co"> last-modified</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Show the code"</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="fu"># Goals of Lab</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Predict whole blood expression from genotype</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Check how well the prediction works with GEUVADIS expression data</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Run association between predicted expression and a phenotype</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Calculate association between expression levels and coronary artery disease risk using s-predixcan</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Fine-map the coronary artery disease gwas results using torus</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Calculate colocalization probability using fastenloc</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Run cTWAS (fine-map SNPs and genes jointly)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="fu"># Inital Remarks</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>We ask you to actively participate in today's hands on activities.</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>Notice that we may ask you to share your screen for pedagogic purposes.</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Send Haky a private message if you really don't want to be called to share your screen.</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>If you have any concerns about this, please ask me or one of the TAs for assistance. We are here to help you learn.</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Open the questionnaire forms at the beginning of each section and answer the questions as you go along</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Name is a mandatory field. You can use your name or a pseudonymn. Just keep using the same name for each submission</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>We will ask you to submit partial set of answers so that we can get a sense of where people are</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Through out the lab you will see code chucks that are written with bash, eval=FALSE in place of R. These chunks are meant to be run in your Rstudio terminal and not in the Rmarkdown file itself.</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>R code chunks also have "eval=FALSE". When you click on the green triangle, the code will run in the R console but not when we knit the document. This just happened to be more convenient for us to generate a knitted html.</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a><span class="fu"># Set Up</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questionnaire 01</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Open and start filling questionnaire 01 Preliminary questionnaire https://forms.gle/fhNJAyjx7MJTy3yt8</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Install packages as needed</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a><span class="co"># List of packages you want to install</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>, <span class="st">"data.table"</span>, <span class="st">"BEDMatrix"</span>, <span class="st">"Rfast"</span>, <span class="st">"susieR"</span>, <span class="st">"coloc"</span>)</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check and install any missing packages</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>check_and_install <span class="ot">&lt;-</span> <span class="cf">function</span>(pkg){</span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(pkg, <span class="at">character.only =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(pkg, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(pkg, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the function to check and install packages</span></span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(packages, check_and_install)</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Load Rstudio Libraries</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a><span class="do">## packages needed for susie+coloc</span></span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BEDMatrix)</span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rfast)</span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(susieR)</span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coloc)</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a><span class="do">##library(tidyverse)</span></span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Navigate to starting directory</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{bash, eval=FALSE}</span></span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="st">"/cloud/project/"</span></span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> activate the the imlabtools environment, which will make sure that the right version of python modules are available</span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a><span class="in">```{bash,eval=FALSE}</span></span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate imlabtools</span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> To define some variables to access the data more easily within the R session, run the following r chunk</span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">getwd</span>())</span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>lab<span class="ot">=</span><span class="st">"/cloud/project/QGT-Columbia-HKI-repo/"</span></span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>CODE<span class="ot">=</span>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{lab}/code"</span>)</span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{CODE}/load_data_functions.R"</span>))</span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{CODE}/plotting_utils_functions.R"</span>))</span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>PRE<span class="ot">=</span><span class="st">"/cloud/project/QGT-Columbia-HKI-repo/box_files"</span></span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>MODEL<span class="ot">=</span>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{PRE}/models"</span>)</span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>DATA<span class="ot">=</span>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{PRE}/data"</span>)</span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a>RESULTS<span class="ot">=</span>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{PRE}/results"</span>)</span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>METAXCAN<span class="ot">=</span>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{PRE}/repos/MetaXcan-master/software"</span>)</span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>FASTENLOC<span class="ot">=</span>glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{PRE}/repos/fastenloc-master"</span>)</span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a reference table we'll use a lot throughout the lab. It contains information about the genes.</span></span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>gencode_df <span class="ot">=</span> <span class="fu">load_gencode_df</span>()</span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> check the values of the variables you just defined in R</span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a>MODEL</span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>DATA</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> define some variables to access the data more easily in the terminal. Remember we are running R code in the R console and command line code in the terminal.</span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{bash, eval=FALSE}</span></span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PRE</span><span class="op">=</span><span class="st">"/cloud/project/QGT-Columbia-HKI-repo/box_files"</span></span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">LAB</span><span class="op">=</span><span class="st">"/cloud/project/QGT-Columbia-HKI-repo/"</span></span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">CODE</span><span class="op">=</span><span class="va">$LAB</span>/code</span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">DATA</span><span class="op">=</span><span class="va">$PRE</span>/data</span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">MODEL</span><span class="op">=</span><span class="va">$PRE</span>/models</span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">RESULTS</span><span class="op">=</span><span class="va">$PRE</span>/results</span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">METAXCAN</span><span class="op">=</span><span class="va">$PRE</span>/repos/MetaXcan-master/software</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> check the values of the variables you just defined</span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a><span class="in">```{bash, eval=FALSE}</span></span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$CODE</span></span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$RESULTS</span></span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a><span class="fu"># Transcriptome-wide association (Review)</span></span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a>Now we will perform a transcriptome-wide association analysis using the PrediXcan suite of tools. <span class="al">![Transcriptome-wide association methods](https://raw.githubusercontent.com/hakyimlab/QGT-Columbia-HKI/master/extras/figures/Association-Methods.png)</span></span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a>We start by predicting the expression levels of genes using the genotype data and the prediction weights and then perform an association between the predicted expression and the phenotype (denoted trait in the figure below).</span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a><span class="al">![](https://raw.githubusercontent.com/hakyimlab/QGT-Columbia-HKI/master/extras/figures/PrediXcan-run.png)</span></span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questionnaire 02</span></span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Open and start filling questionnaire 02 Prediction https://forms.gle/T6kAHvFTxYfcQguW7</span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a><span class="fu"># Predict Expression from genotype</span></span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a>In this section we will predict expression of genes in whole blood using the Predict.py code in the METAXCAN folder.</span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Prediction models (weights) are located in the MODEL folder. Additional models for different tissues and transcriptome studies can be downloaded from <span class="co">[</span><span class="ot">predictdb.org</span><span class="co">](http://predictdb.org)</span>.</span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>This run should take about one minute.</span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> run the following code in the terminal.</span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{bash, eval=FALSE}</span></span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a><span class="bu">printf</span> <span class="st">"Predict expression\n\n"</span></span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="va">$METAXCAN</span>/Predict.py <span class="dt">\</span></span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a>--model_db_path <span class="va">$PRE</span>/models/gtex_v8_en/en_Whole_Blood.db <span class="dt">\</span></span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a>--vcf_genotypes <span class="va">$DATA</span>/predixcan/genotype/filtered.vcf.gz <span class="dt">\</span></span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a>--vcf_mode genotyped <span class="dt">\</span></span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a>--variant_mapping <span class="va">$DATA</span>/predixcan/gtex_v8_eur_filtered_maf0.01_monoallelic_variants.txt.gz id rsid <span class="dt">\</span></span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a>--on_the_fly_mapping METADATA <span class="st">"chr{}_{}_{}_{}_b38"</span> <span class="dt">\</span></span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a>--prediction_output <span class="va">$RESULTS</span>/predixcan/Whole_Blood__predict.txt <span class="dt">\</span></span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a>--prediction_summary_output <span class="va">$RESULTS</span>/predixcan/Whole_Blood__summary.txt <span class="dt">\</span></span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a>--verbosity 9 <span class="dt">\</span></span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a>--throw</span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Note we are only predicting chromosome 22 here (check by running "predicted_expression %</span><span class="sc">\&gt;</span><span class="at">% count(chromosome)" in the console)</span></span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> run following code in the console to get information on reported prediction performance.</span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Find additional information </span><span class="co">[</span><span class="ot">in this wiki</span><span class="co">](https://github.com/hakyimlab/MetaXcan/wiki/Individual-level-PrediXcan:-introduction,-tutorials-and-manual)</span></span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a>prediction_fp <span class="ot">=</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{RESULTS}/predixcan/Whole_Blood__predict.txt"</span>)</span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a><span class="do">## Read the Predict.py output into a dataframe. This function reorganizes the data and adds gene names.</span></span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a>predicted_expression <span class="ot">=</span> <span class="fu">load_predicted_expression</span>(prediction_fp, gencode_df)</span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(predicted_expression)</span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a><span class="do">## read summary of prediction, number of SNPs per gene, cross validated prediction performance</span></span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a>prediction_summary <span class="ot">=</span> <span class="fu">load_prediction_summary</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{RESULTS}/predixcan/Whole_Blood__summary.txt"</span>), gencode_df)</span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a><span class="do">## number of genes with a prediction model</span></span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(prediction_summary)</span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(prediction_summary)</span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a><span class="do">## how many unique genes were predicted?</span></span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a>predicted_expression <span class="sc">%&gt;%</span> .[[<span class="st">"gene_id"</span>]] <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a><span class="do">## gene expression were predicted for how many people?</span></span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a>predicted_expression <span class="sc">%&gt;%</span> .[[<span class="st">"IID"</span>]] <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"distribution of prediction performance r2"</span>)</span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(prediction_summary<span class="sc">$</span>pred_perf_r2)</span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(prediction_summary<span class="sc">$</span>pred_perf_r2)</span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a><span class="do">## Note: this is what the prediction trainer reported as prediction performance</span></span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a><span class="fu">## (Optional) Assess Actual Prediction Performance</span></span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a><span class="do">## download and read observed expression data from GEUVADIS </span></span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a><span class="do">## from https://uchicago.box.com/s/4y7xle5l0pnq9d1fwmthe2ewhogrnlrv</span></span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a>obs_exp<span class="ot">&lt;-</span> <span class="fu">read_csv</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/predixcan/GEUVADIS.observed_df.csv.gz"</span>))</span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a><span class="do">## Note that the version of the ensemble id of the gene was removed</span></span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(predicted_expression)</span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a><span class="do">## Q: how many genes were predicted?</span></span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(predicted_expression<span class="sc">$</span>gene_id))</span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a><span class="do">## inner join predicted expression with observed expression data (by IID and gene)</span></span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a><span class="do">## common errors occur when ensemble id's have versions in one set and not the other set</span></span>
<span id="cb31-237"><a href="#cb31-237" aria-hidden="true" tabindex="-1"></a>fullset<span class="ot">=</span><span class="fu">inner_join</span>(predicted_expression, obs_exp, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"gene_id"</span>,<span class="st">"IID"</span>))</span>
<span id="cb31-238"><a href="#cb31-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate spearman correlation for all genes</span></span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a>genelist <span class="ot">=</span> <span class="fu">unique</span>(predicted_expression<span class="sc">$</span>gene_id)</span>
<span id="cb31-241"><a href="#cb31-241" aria-hidden="true" tabindex="-1"></a>corvec <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">length</span>(genelist))</span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(corvec) <span class="ot">=</span> genelist</span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(gg <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(genelist))</span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a>  ind <span class="ot">=</span> fullset<span class="sc">$</span>gene_id<span class="sc">==</span>genelist[gg]</span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a>  corvec[gg] <span class="ot">=</span> <span class="fu">cor</span>(fullset<span class="sc">$</span>predicted_expression[ind], fullset<span class="sc">$</span>observed_expression[ind])</span>
<span id="cb31-247"><a href="#cb31-247" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-248"><a href="#cb31-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a><span class="do">## what's the best performing gene?</span></span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a><span class="do">## plot the histogram of the prediction performance</span></span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(corvec)</span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-254"><a href="#cb31-254" aria-hidden="true" tabindex="-1"></a><span class="do">## list the top 10 best performing genes</span></span>
<span id="cb31-255"><a href="#cb31-255" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">sort</span>(corvec,<span class="at">decreasing =</span> <span class="cn">TRUE</span>),<span class="dv">2</span>)</span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(<span class="fu">sort</span>(corvec,<span class="at">decreasing =</span> <span class="cn">TRUE</span>),<span class="dv">2</span>)</span>
<span id="cb31-257"><a href="#cb31-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-258"><a href="#cb31-258" aria-hidden="true" tabindex="-1"></a><span class="do">## plot the correlation of the top 2 best performing genes bottom 2</span></span>
<span id="cb31-259"><a href="#cb31-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-260"><a href="#cb31-260" aria-hidden="true" tabindex="-1"></a>geneid <span class="ot">=</span> <span class="st">"ENSG00000100376"</span></span>
<span id="cb31-261"><a href="#cb31-261" aria-hidden="true" tabindex="-1"></a>genename <span class="ot">=</span> gencode_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> .[[<span class="st">"gene_name"</span>]]</span>
<span id="cb31-262"><a href="#cb31-262" aria-hidden="true" tabindex="-1"></a>fullset <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(observed_expression, predicted_expression))<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="fu">paste</span>(genename, <span class="st">"-"</span>,geneid))</span>
<span id="cb31-263"><a href="#cb31-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-264"><a href="#cb31-264" aria-hidden="true" tabindex="-1"></a>geneid <span class="ot">=</span> <span class="st">"ENSG00000075234"</span></span>
<span id="cb31-265"><a href="#cb31-265" aria-hidden="true" tabindex="-1"></a>genename <span class="ot">=</span> gencode_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> .[[<span class="st">"gene_name"</span>]]</span>
<span id="cb31-266"><a href="#cb31-266" aria-hidden="true" tabindex="-1"></a>fullset <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(observed_expression, predicted_expression))<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="fu">paste</span>(genename, <span class="st">"-"</span>, geneid))</span>
<span id="cb31-267"><a href="#cb31-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-268"><a href="#cb31-268" aria-hidden="true" tabindex="-1"></a>geneid <span class="ot">=</span> <span class="st">"ENSG00000070371"</span></span>
<span id="cb31-269"><a href="#cb31-269" aria-hidden="true" tabindex="-1"></a>genename <span class="ot">=</span> gencode_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> .[[<span class="st">"gene_name"</span>]]</span>
<span id="cb31-270"><a href="#cb31-270" aria-hidden="true" tabindex="-1"></a>fullset <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(observed_expression, predicted_expression))<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="fu">paste</span>(genename, <span class="st">"-"</span>, geneid))</span>
<span id="cb31-271"><a href="#cb31-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-272"><a href="#cb31-272" aria-hidden="true" tabindex="-1"></a>geneid <span class="ot">=</span> <span class="st">"ENSG00000184164"</span></span>
<span id="cb31-273"><a href="#cb31-273" aria-hidden="true" tabindex="-1"></a>genename <span class="ot">=</span> gencode_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> .[[<span class="st">"gene_name"</span>]]</span>
<span id="cb31-274"><a href="#cb31-274" aria-hidden="true" tabindex="-1"></a>fullset <span class="sc">%&gt;%</span> <span class="fu">filter</span>(gene_id<span class="sc">==</span>geneid) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(observed_expression, predicted_expression))<span class="sc">+</span><span class="fu">geom_point</span>()<span class="sc">+</span><span class="fu">ggtitle</span>(<span class="fu">paste</span>(genename, <span class="st">"-"</span>, geneid))</span>
<span id="cb31-275"><a href="#cb31-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-276"><a href="#cb31-276" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-277"><a href="#cb31-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-278"><a href="#cb31-278" aria-hidden="true" tabindex="-1"></a><span class="fu"># Run PrediXcan association</span></span>
<span id="cb31-279"><a href="#cb31-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-280"><a href="#cb31-280" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questionnaire 03</span></span>
<span id="cb31-281"><a href="#cb31-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-282"><a href="#cb31-282" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Open and start filling questionnaire 03 PrediXcan https://forms.gle/3H319knWbLgnynNs9</span>
<span id="cb31-283"><a href="#cb31-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-284"><a href="#cb31-284" aria-hidden="true" tabindex="-1"></a>We are going to use a simulated phenotype for which only UPK3A has an effect on the phenotype ($\beta=-0.9887378$)</span>
<span id="cb31-285"><a href="#cb31-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-286"><a href="#cb31-286" aria-hidden="true" tabindex="-1"></a>$Y = \sum_k T_k \beta_k + \epsilon$</span>
<span id="cb31-287"><a href="#cb31-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-288"><a href="#cb31-288" aria-hidden="true" tabindex="-1"></a>with random effects $\beta_k \sim (1-\pi)\cdot \delta_0 + \pi\cdot N(0,1)$</span>
<span id="cb31-289"><a href="#cb31-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-290"><a href="#cb31-290" aria-hidden="true" tabindex="-1"></a><span class="in">```{bash, eval=FALSE}</span></span>
<span id="cb31-291"><a href="#cb31-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-292"><a href="#cb31-292" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PHENO</span><span class="op">=</span><span class="st">"sim.spike_n_slab_0.01_pve0.1"</span></span>
<span id="cb31-293"><a href="#cb31-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-294"><a href="#cb31-294" aria-hidden="true" tabindex="-1"></a><span class="bu">printf</span> <span class="st">"association\n\n"</span></span>
<span id="cb31-295"><a href="#cb31-295" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="va">$METAXCAN</span>/PrediXcanAssociation.py <span class="dt">\</span></span>
<span id="cb31-296"><a href="#cb31-296" aria-hidden="true" tabindex="-1"></a>--expression_file <span class="va">$RESULTS</span>/predixcan/Whole_Blood__predict.txt <span class="dt">\</span></span>
<span id="cb31-297"><a href="#cb31-297" aria-hidden="true" tabindex="-1"></a>--input_phenos_file <span class="va">$DATA</span>/predixcan/phenotype/<span class="va">$PHENO</span>.txt <span class="dt">\</span></span>
<span id="cb31-298"><a href="#cb31-298" aria-hidden="true" tabindex="-1"></a>--input_phenos_column pheno <span class="dt">\</span></span>
<span id="cb31-299"><a href="#cb31-299" aria-hidden="true" tabindex="-1"></a>--output <span class="va">$RESULTS</span>/predixcan/<span class="va">$PHENO</span>/Whole_Blood__association.txt <span class="dt">\</span></span>
<span id="cb31-300"><a href="#cb31-300" aria-hidden="true" tabindex="-1"></a>--verbosity 9 <span class="dt">\</span></span>
<span id="cb31-301"><a href="#cb31-301" aria-hidden="true" tabindex="-1"></a>--throw</span>
<span id="cb31-302"><a href="#cb31-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-303"><a href="#cb31-303" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-304"><a href="#cb31-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-305"><a href="#cb31-305" aria-hidden="true" tabindex="-1"></a>More predicted phenotypes can be found in \$DATA/predixcan/phenotype/. The naming of the phenotypes provides information about the genetic architecture: the number after pve is the proportion of variance of Y explained by the genetic component of expression. The number after spike_n<span class="sc">\_</span>slab represents the probability that a gene is causal π (i.e. prob β≠0)</span>
<span id="cb31-306"><a href="#cb31-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-307"><a href="#cb31-307" aria-hidden="true" tabindex="-1"></a><span class="fu">## Looking at Association Results</span></span>
<span id="cb31-308"><a href="#cb31-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-309"><a href="#cb31-309" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb31-310"><a href="#cb31-310" aria-hidden="true" tabindex="-1"></a><span class="do">## read association results</span></span>
<span id="cb31-311"><a href="#cb31-311" aria-hidden="true" tabindex="-1"></a>PHENO<span class="ot">=</span><span class="st">"sim.spike_n_slab_0.01_pve0.1"</span></span>
<span id="cb31-312"><a href="#cb31-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-313"><a href="#cb31-313" aria-hidden="true" tabindex="-1"></a>predixcan_association <span class="ot">=</span> <span class="fu">load_predixcan_association</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{RESULTS}/predixcan/{PHENO}/Whole_Blood__association.txt"</span>), gencode_df)</span>
<span id="cb31-314"><a href="#cb31-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-315"><a href="#cb31-315" aria-hidden="true" tabindex="-1"></a><span class="do">## take a look at the results</span></span>
<span id="cb31-316"><a href="#cb31-316" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(predixcan_association)</span>
<span id="cb31-317"><a href="#cb31-317" aria-hidden="true" tabindex="-1"></a>predixcan_association <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> <span class="fu">select</span>(gene_name,effect,se,pvalue,gene) <span class="sc">%&gt;%</span> head</span>
<span id="cb31-318"><a href="#cb31-318" aria-hidden="true" tabindex="-1"></a>predixcan_association <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(pvalue)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins=</span><span class="dv">10</span>)</span>
<span id="cb31-319"><a href="#cb31-319" aria-hidden="true" tabindex="-1"></a><span class="do">## compare distribution against the null (uniform)</span></span>
<span id="cb31-320"><a href="#cb31-320" aria-hidden="true" tabindex="-1"></a><span class="fu">gg_qqplot</span>(predixcan_association<span class="sc">$</span>pvalue, <span class="at">max_yval =</span> <span class="dv">40</span>)</span>
<span id="cb31-321"><a href="#cb31-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-322"><a href="#cb31-322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-323"><a href="#cb31-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-324"><a href="#cb31-324" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparing the Estimated Effect Size with True Effect Size</span></span>
<span id="cb31-325"><a href="#cb31-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-326"><a href="#cb31-326" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-327"><a href="#cb31-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-328"><a href="#cb31-328" aria-hidden="true" tabindex="-1"></a>truebetas <span class="ot">=</span> <span class="fu">load_truebetas</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/predixcan/phenotype/gene-effects/{PHENO}.txt"</span>), gencode_df)</span>
<span id="cb31-329"><a href="#cb31-329" aria-hidden="true" tabindex="-1"></a>betas <span class="ot">=</span> (predixcan_association <span class="sc">%&gt;%</span> </span>
<span id="cb31-330"><a href="#cb31-330" aria-hidden="true" tabindex="-1"></a>               <span class="fu">inner_join</span>(truebetas,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"gene"</span><span class="ot">=</span><span class="st">"gene_id"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-331"><a href="#cb31-331" aria-hidden="true" tabindex="-1"></a>               <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">'estimated_beta'</span><span class="ot">=</span><span class="st">'effect'</span>, </span>
<span id="cb31-332"><a href="#cb31-332" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'true_beta'</span><span class="ot">=</span><span class="st">'effect_size'</span>,</span>
<span id="cb31-333"><a href="#cb31-333" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'pvalue'</span>, </span>
<span id="cb31-334"><a href="#cb31-334" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'gene_id'</span><span class="ot">=</span><span class="st">'gene'</span>, </span>
<span id="cb31-335"><a href="#cb31-335" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'gene_name'</span><span class="ot">=</span><span class="st">'gene_name.x'</span>, </span>
<span id="cb31-336"><a href="#cb31-336" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'region_id'</span><span class="ot">=</span><span class="st">'region_id.x'</span>)))</span>
<span id="cb31-337"><a href="#cb31-337" aria-hidden="true" tabindex="-1"></a>betas <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> <span class="fu">select</span>(gene_name,estimated_beta,true_beta,pvalue) <span class="sc">%&gt;%</span> head</span>
<span id="cb31-338"><a href="#cb31-338" aria-hidden="true" tabindex="-1"></a><span class="do">## do you see examples of potential LD contamination?</span></span>
<span id="cb31-339"><a href="#cb31-339" aria-hidden="true" tabindex="-1"></a>betas <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">causal=</span> true_beta<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(estimated_beta, true_beta,<span class="at">col=</span>causal))<span class="sc">+</span><span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.6</span>,<span class="at">size=</span><span class="dv">5</span>)<span class="sc">+</span><span class="fu">geom_abline</span>()<span class="sc">+</span><span class="fu">theme_bw</span>()</span>
<span id="cb31-340"><a href="#cb31-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-341"><a href="#cb31-341" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-342"><a href="#cb31-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-343"><a href="#cb31-343" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; UPK3A is the causal gene and has the most significant pvalue. RIBC2 is also significantly associated but has no causal role (we know because we simulated the phenotype that way). Why?</span></span>
<span id="cb31-344"><a href="#cb31-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-345"><a href="#cb31-345" aria-hidden="true" tabindex="-1"></a>Hint: correlation between the genes</span>
<span id="cb31-346"><a href="#cb31-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-347"><a href="#cb31-347" aria-hidden="true" tabindex="-1"></a><span class="fu"># Run Summary PrediXcan</span></span>
<span id="cb31-348"><a href="#cb31-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-349"><a href="#cb31-349" aria-hidden="true" tabindex="-1"></a>Now we will use the summary results from a GWAS of coronary artery disease to calculate the association between the genetic component of the expression of genes and coronary artery disease risk. We will use the SPrediXcan.py.</span>
<span id="cb31-350"><a href="#cb31-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-351"><a href="#cb31-351" aria-hidden="true" tabindex="-1"></a><span class="al">![](https://uchicago.box.com/shared/static/m45nnkeskzh88ifnv8td5e3fntdfzhjs.png)</span></span>
<span id="cb31-352"><a href="#cb31-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-353"><a href="#cb31-353" aria-hidden="true" tabindex="-1"></a>The GWAS results (harmonized and imputed) for coronary artery disease are available in \$PRE/spredixcan/data/</span>
<span id="cb31-354"><a href="#cb31-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-355"><a href="#cb31-355" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questionnaire 04</span></span>
<span id="cb31-356"><a href="#cb31-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-357"><a href="#cb31-357" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Open and start filling questionnaire 04 S-PrediXcan https://forms.gle/xJs2U66cnrqdb5cj6</span>
<span id="cb31-358"><a href="#cb31-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-359"><a href="#cb31-359" aria-hidden="true" tabindex="-1"></a><span class="fu">## Running S-PrediXcan</span></span>
<span id="cb31-360"><a href="#cb31-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-361"><a href="#cb31-361" aria-hidden="true" tabindex="-1"></a><span class="in">```{bash, eval=FALSE}</span></span>
<span id="cb31-362"><a href="#cb31-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-363"><a href="#cb31-363" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="va">$METAXCAN</span>/SPrediXcan.py <span class="dt">\</span></span>
<span id="cb31-364"><a href="#cb31-364" aria-hidden="true" tabindex="-1"></a>--gwas_file  <span class="va">$DATA</span>/spredixcan/imputed_CARDIoGRAM_C4D_CAD_ADDITIVE.txt.gz <span class="dt">\</span></span>
<span id="cb31-365"><a href="#cb31-365" aria-hidden="true" tabindex="-1"></a>--snp_column panel_variant_id <span class="dt">\</span></span>
<span id="cb31-366"><a href="#cb31-366" aria-hidden="true" tabindex="-1"></a>--effect_allele_column effect_allele <span class="dt">\</span></span>
<span id="cb31-367"><a href="#cb31-367" aria-hidden="true" tabindex="-1"></a>--non_effect_allele_column non_effect_allele <span class="dt">\</span></span>
<span id="cb31-368"><a href="#cb31-368" aria-hidden="true" tabindex="-1"></a>--zscore_column zscore <span class="dt">\</span></span>
<span id="cb31-369"><a href="#cb31-369" aria-hidden="true" tabindex="-1"></a>--model_db_path <span class="va">$MODEL</span>/gtex_v8_mashr/mashr_Whole_Blood.db <span class="dt">\</span></span>
<span id="cb31-370"><a href="#cb31-370" aria-hidden="true" tabindex="-1"></a>--covariance <span class="va">$MODEL</span>/gtex_v8_mashr/mashr_Whole_Blood.txt.gz <span class="dt">\</span></span>
<span id="cb31-371"><a href="#cb31-371" aria-hidden="true" tabindex="-1"></a>--keep_non_rsid <span class="dt">\</span></span>
<span id="cb31-372"><a href="#cb31-372" aria-hidden="true" tabindex="-1"></a>--additional_output <span class="dt">\</span></span>
<span id="cb31-373"><a href="#cb31-373" aria-hidden="true" tabindex="-1"></a>--model_db_snp_key varID <span class="dt">\</span></span>
<span id="cb31-374"><a href="#cb31-374" aria-hidden="true" tabindex="-1"></a>--throw <span class="dt">\</span></span>
<span id="cb31-375"><a href="#cb31-375" aria-hidden="true" tabindex="-1"></a>--output_file <span class="va">$RESULTS</span>/spredixcan/eqtl/CARDIoGRAM_C4D_CAD_ADDITIVE__PM__Whole_Blood.csv</span>
<span id="cb31-376"><a href="#cb31-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-377"><a href="#cb31-377" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-378"><a href="#cb31-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-379"><a href="#cb31-379" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; We can run the full genome because the summary statistics based PrediXcan is much faster than individual level one.</span></span>
<span id="cb31-380"><a href="#cb31-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-381"><a href="#cb31-381" aria-hidden="true" tabindex="-1"></a><span class="fu">## Plot and Interpret Results</span></span>
<span id="cb31-382"><a href="#cb31-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-383"><a href="#cb31-383" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb31-384"><a href="#cb31-384" aria-hidden="true" tabindex="-1"></a>spredixcan_association <span class="ot">=</span> <span class="fu">load_spredixcan_association</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{RESULTS}/spredixcan/eqtl/CARDIoGRAM_C4D_CAD_ADDITIVE__PM__Whole_Blood.csv"</span>), gencode_df)</span>
<span id="cb31-385"><a href="#cb31-385" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(spredixcan_association)</span>
<span id="cb31-386"><a href="#cb31-386" aria-hidden="true" tabindex="-1"></a>spredixcan_association <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> head</span>
<span id="cb31-387"><a href="#cb31-387" aria-hidden="true" tabindex="-1"></a>spredixcan_association <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(pvalue)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins=</span><span class="dv">20</span>)</span>
<span id="cb31-388"><a href="#cb31-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-389"><a href="#cb31-389" aria-hidden="true" tabindex="-1"></a><span class="fu">gg_qqplot</span>(spredixcan_association<span class="sc">$</span>pvalue)</span>
<span id="cb31-390"><a href="#cb31-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-391"><a href="#cb31-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-392"><a href="#cb31-392" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Question:* SORT1, considered to be a causal gene for LDL cholesterol and as a consequence of coronary artery disease, is not found here. Why?</span>
<span id="cb31-393"><a href="#cb31-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-394"><a href="#cb31-394" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> check whether SORT1 is expressed in whole blood <span class="co">[</span><span class="ot">GTEx portal</span><span class="co">](https://gtexportal.org/home/gene/SORT1)</span></span>
<span id="cb31-395"><a href="#cb31-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-396"><a href="#cb31-396" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> check whether SORT1 has eQTL in whole blood <span class="co">[</span><span class="ot">GTEx portal</span><span class="co">](https://gtexportal.org/home/gene/SORT1)</span></span>
<span id="cb31-397"><a href="#cb31-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-398"><a href="#cb31-398" aria-hidden="true" tabindex="-1"></a><span class="fu">## Run S-PrediXcan using gene expression predicted in liver</span></span>
<span id="cb31-399"><a href="#cb31-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-400"><a href="#cb31-400" aria-hidden="true" tabindex="-1"></a>-<span class="sc">\[\]</span> Run s-predixcan with liver model, do you find SORT1? Is it significant?</span>
<span id="cb31-401"><a href="#cb31-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-402"><a href="#cb31-402" aria-hidden="true" tabindex="-1"></a><span class="in">```{bash, eval=FALSE}</span></span>
<span id="cb31-403"><a href="#cb31-403" aria-hidden="true" tabindex="-1"></a><span class="co">#loction Liver models </span></span>
<span id="cb31-404"><a href="#cb31-404" aria-hidden="true" tabindex="-1"></a><span class="co">#/cloud/project/QGT-Columbia-HKI-repo/box_files/models/gtex_v8_mashr/</span></span>
<span id="cb31-405"><a href="#cb31-405" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="va">$METAXCAN</span>/SPrediXcan.py <span class="dt">\</span></span>
<span id="cb31-406"><a href="#cb31-406" aria-hidden="true" tabindex="-1"></a>--gwas_file  <span class="va">$DATA</span>/spredixcan/imputed_CARDIoGRAM_C4D_CAD_ADDITIVE.txt.gz <span class="dt">\</span></span>
<span id="cb31-407"><a href="#cb31-407" aria-hidden="true" tabindex="-1"></a>--snp_column panel_variant_id <span class="dt">\</span></span>
<span id="cb31-408"><a href="#cb31-408" aria-hidden="true" tabindex="-1"></a>--effect_allele_column effect_allele <span class="dt">\</span></span>
<span id="cb31-409"><a href="#cb31-409" aria-hidden="true" tabindex="-1"></a>--non_effect_allele_column non_effect_allele <span class="dt">\</span></span>
<span id="cb31-410"><a href="#cb31-410" aria-hidden="true" tabindex="-1"></a>--zscore_column zscore <span class="dt">\</span></span>
<span id="cb31-411"><a href="#cb31-411" aria-hidden="true" tabindex="-1"></a>--model_db_path <span class="va">$MODEL</span>/gtex_v8_mashr/mashr_Liver.db <span class="dt">\</span></span>
<span id="cb31-412"><a href="#cb31-412" aria-hidden="true" tabindex="-1"></a>--covariance <span class="va">$MODEL</span>/gtex_v8_mashr/mashr_Liver.txt.gz <span class="dt">\</span></span>
<span id="cb31-413"><a href="#cb31-413" aria-hidden="true" tabindex="-1"></a>--keep_non_rsid <span class="dt">\</span></span>
<span id="cb31-414"><a href="#cb31-414" aria-hidden="true" tabindex="-1"></a>--additional_output <span class="dt">\</span></span>
<span id="cb31-415"><a href="#cb31-415" aria-hidden="true" tabindex="-1"></a>--model_db_snp_key varID <span class="dt">\</span></span>
<span id="cb31-416"><a href="#cb31-416" aria-hidden="true" tabindex="-1"></a>--throw <span class="dt">\</span></span>
<span id="cb31-417"><a href="#cb31-417" aria-hidden="true" tabindex="-1"></a>--output_file <span class="va">$RESULTS</span>/spredixcan/eqtl/CARDIoGRAM_C4D_CAD_ADDITIVE__PM__Liver.csv</span>
<span id="cb31-418"><a href="#cb31-418" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-419"><a href="#cb31-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-420"><a href="#cb31-420" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb31-421"><a href="#cb31-421" aria-hidden="true" tabindex="-1"></a>spredixcan_association_L<span class="ot">=</span> <span class="fu">load_spredixcan_association</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{RESULTS}/spredixcan/eqtl/CARDIoGRAM_C4D_CAD_ADDITIVE__PM__Liver.csv"</span>), gencode_df)</span>
<span id="cb31-422"><a href="#cb31-422" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(spredixcan_association_L)</span>
<span id="cb31-423"><a href="#cb31-423" aria-hidden="true" tabindex="-1"></a>spredixcan_association_L <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> head</span>
<span id="cb31-424"><a href="#cb31-424" aria-hidden="true" tabindex="-1"></a>spredixcan_association_L <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(pvalue) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(pvalue)) <span class="sc">+</span> <span class="fu">geom_histogram</span>(<span class="at">bins=</span><span class="dv">20</span>)</span>
<span id="cb31-425"><a href="#cb31-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-426"><a href="#cb31-426" aria-hidden="true" tabindex="-1"></a><span class="fu">gg_qqplot</span>(spredixcan_association_L<span class="sc">$</span>pvalue)</span>
<span id="cb31-427"><a href="#cb31-427" aria-hidden="true" tabindex="-1"></a>col_order<span class="ot">=</span> <span class="fu">c</span>(<span class="st">"gene_name"</span>,<span class="st">"gene"</span>,<span class="st">"zscore"</span>,<span class="st">"effect_size"</span>,<span class="st">"pvalue"</span>,<span class="st">"var_g"</span>,<span class="st">"pred_perf_r2"</span>, <span class="st">"pred_perf_pval"</span>,<span class="st">"pred_perf_qval"</span>, <span class="st">"n_snps_used"</span>, <span class="st">"n_snps_in_cov"</span>, <span class="st">"n_snps_in_model"</span>,<span class="st">"best_gwas_p"</span>,<span class="st">"largest_weight"</span>)</span>
<span id="cb31-428"><a href="#cb31-428" aria-hidden="true" tabindex="-1"></a>spredixcan_association_L <span class="ot">&lt;-</span> spredixcan_association_L[, col_order]</span>
<span id="cb31-429"><a href="#cb31-429" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(spredixcan_association_L, gene_name<span class="sc">==</span><span class="st">"SORT1"</span>)</span>
<span id="cb31-430"><a href="#cb31-430" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-431"><a href="#cb31-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-432"><a href="#cb31-432" aria-hidden="true" tabindex="-1"></a><span class="fu">## (Optional) Compare zscores in liver and whole blood.</span></span>
<span id="cb31-433"><a href="#cb31-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-434"><a href="#cb31-434" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Recall that zscore is the effect size divided by the standard error</span></span>
<span id="cb31-435"><a href="#cb31-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-436"><a href="#cb31-436" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-437"><a href="#cb31-437" aria-hidden="true" tabindex="-1"></a>spredixcan_association_L<span class="ot">=</span><span class="fu">rename</span>(spredixcan_association_L, <span class="at">zscore_liver =</span> <span class="st">"zscore"</span>)</span>
<span id="cb31-438"><a href="#cb31-438" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(spredixcan_association_L)</span>
<span id="cb31-439"><a href="#cb31-439" aria-hidden="true" tabindex="-1"></a>test<span class="ot">=</span><span class="fu">left_join</span>(spredixcan_association, spredixcan_association_L, <span class="at">by=</span><span class="st">"gene_name"</span>)</span>
<span id="cb31-440"><a href="#cb31-440" aria-hidden="true" tabindex="-1"></a>test<span class="ot">=</span><span class="fu">select</span>(test,<span class="st">"gene_name"</span>,<span class="st">"zscore"</span>,<span class="st">"zscore_liver"</span>)</span>
<span id="cb31-441"><a href="#cb31-441" aria-hidden="true" tabindex="-1"></a>test <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(zscore_liver) <span class="sc">%&gt;%</span> head</span>
<span id="cb31-442"><a href="#cb31-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-443"><a href="#cb31-443" aria-hidden="true" tabindex="-1"></a>test <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">zscore_WB=</span>zscore) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(zscore_WB,zscore_liver)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">3</span>,<span class="at">alpha=</span>.<span class="dv">6</span>) <span class="sc">+</span> <span class="fu">geom_abline</span>()</span>
<span id="cb31-444"><a href="#cb31-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-445"><a href="#cb31-445" aria-hidden="true" tabindex="-1"></a><span class="do">## S-PrediXcan association in liver and whole blood are significantly correlated</span></span>
<span id="cb31-446"><a href="#cb31-446" aria-hidden="true" tabindex="-1"></a><span class="fu">cor.test</span>(test<span class="sc">$</span>zscore,test<span class="sc">$</span>zscore_liver)</span>
<span id="cb31-447"><a href="#cb31-447" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-448"><a href="#cb31-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-449"><a href="#cb31-449" aria-hidden="true" tabindex="-1"></a><span class="fu">## (Optional) Run MultiXcan</span></span>
<span id="cb31-450"><a href="#cb31-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-451"><a href="#cb31-451" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>multixcan aggregates information across multiple tissues to boost the power to detect association. It was developed movivated by the fact that eQTLs are shared across multiple tissues, i.e. many genetic variants that regulate expression are common across tissues.</span>
<span id="cb31-452"><a href="#cb31-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-453"><a href="#cb31-453" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>before you run multixcan ensure you have run s-predixcan for all the tissues you want to multixcan. In this tutorial we have two tissues (liver and whole blood), ensure you have run s-predixcan with the two tissues before running multixcan.</span>
<span id="cb31-454"><a href="#cb31-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-455"><a href="#cb31-455" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>One thing to note is to ensure similar naming pattern for the output files. This is to ensure the files are captured correctly when running multixcan's filter.</span>
<span id="cb31-456"><a href="#cb31-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-457"><a href="#cb31-457" aria-hidden="true" tabindex="-1"></a><span class="in">```{bash, eval=FALSE}</span></span>
<span id="cb31-458"><a href="#cb31-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-459"><a href="#cb31-459" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="va">$METAXCAN</span>/SMulTiXcan.py <span class="dt">\</span></span>
<span id="cb31-460"><a href="#cb31-460" aria-hidden="true" tabindex="-1"></a>--models_folder <span class="va">$MODEL</span>/gtex_v8_mashr <span class="dt">\</span></span>
<span id="cb31-461"><a href="#cb31-461" aria-hidden="true" tabindex="-1"></a>--models_name_pattern <span class="st">"mashr_(.*).db"</span> <span class="dt">\</span></span>
<span id="cb31-462"><a href="#cb31-462" aria-hidden="true" tabindex="-1"></a>--snp_covariance <span class="va">$MODEL</span>/gtex_v8_expression_mashr_snp_smultixcan_covariance.txt.gz <span class="dt">\</span></span>
<span id="cb31-463"><a href="#cb31-463" aria-hidden="true" tabindex="-1"></a>--metaxcan_folder <span class="va">$RESULTS</span>/spredixcan/eqtl/ <span class="dt">\</span></span>
<span id="cb31-464"><a href="#cb31-464" aria-hidden="true" tabindex="-1"></a>--metaxcan_filter <span class="st">"CARDIoGRAM_C4D_CAD_ADDITIVE__PM__(.*).csv"</span> <span class="dt">\</span></span>
<span id="cb31-465"><a href="#cb31-465" aria-hidden="true" tabindex="-1"></a>--metaxcan_file_name_parse_pattern <span class="st">"(.*)__PM__(.*).csv"</span> <span class="dt">\</span></span>
<span id="cb31-466"><a href="#cb31-466" aria-hidden="true" tabindex="-1"></a>--gwas_file <span class="va">$DATA</span>/spredixcan/imputed_CARDIoGRAM_C4D_CAD_ADDITIVE.txt.gz <span class="dt">\</span></span>
<span id="cb31-467"><a href="#cb31-467" aria-hidden="true" tabindex="-1"></a>--snp_column panel_variant_id <span class="at">--effect_allele_column</span> effect_allele <span class="at">--non_effect_allele_column</span> non_effect_allele <span class="at">--zscore_column</span> zscore <span class="at">--keep_non_rsid</span> <span class="at">--model_db_snp_key</span> varID <span class="dt">\</span></span>
<span id="cb31-468"><a href="#cb31-468" aria-hidden="true" tabindex="-1"></a>--cutoff_condition_number 30 <span class="dt">\</span></span>
<span id="cb31-469"><a href="#cb31-469" aria-hidden="true" tabindex="-1"></a>--verbosity 9 <span class="dt">\</span></span>
<span id="cb31-470"><a href="#cb31-470" aria-hidden="true" tabindex="-1"></a>--throw <span class="dt">\</span></span>
<span id="cb31-471"><a href="#cb31-471" aria-hidden="true" tabindex="-1"></a>--output <span class="va">$RESULTS</span>/smultixcan/eqtl/CARDIoGRAM_C4D_CAD_ADDITIVE_smultixcan.txt</span>
<span id="cb31-472"><a href="#cb31-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-473"><a href="#cb31-473" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-474"><a href="#cb31-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-475"><a href="#cb31-475" aria-hidden="true" tabindex="-1"></a><span class="fu"># Colocalization Methods (Review)</span></span>
<span id="cb31-476"><a href="#cb31-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-477"><a href="#cb31-477" aria-hidden="true" tabindex="-1"></a>Colocalization methods seek to estimate the probability that the complex trait and expression causal variants are the same. We favor methods that calculate the probability of causality for each trait (posterior inclusion probability), called fine-mapping methods. Here we use susie for fine-mapping and coloc for colocalization.</span>
<span id="cb31-478"><a href="#cb31-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-479"><a href="#cb31-479" aria-hidden="true" tabindex="-1"></a><span class="al">![](https://raw.githubusercontent.com/hakyimlab/QGT-Columbia-HKI/master/extras/figures/colocalization-run.png)</span></span>
<span id="cb31-480"><a href="#cb31-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-481"><a href="#cb31-481" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questionnaire 5</span></span>
<span id="cb31-482"><a href="#cb31-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-483"><a href="#cb31-483" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Open and start filling questionnaire 05 Colocalization https://forms.gle/NfH2MSdy4UyJzGAp7</span>
<span id="cb31-484"><a href="#cb31-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-485"><a href="#cb31-485" aria-hidden="true" tabindex="-1"></a><span class="fu">## Run colocalization</span></span>
<span id="cb31-486"><a href="#cb31-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-487"><a href="#cb31-487" aria-hidden="true" tabindex="-1"></a>When you use coloc on your own data, you may want to check out coloc's documentation, with good advice and tips on avoiding common mistakes https://cran.r-project.org/web/packages/coloc/vignettes</span>
<span id="cb31-488"><a href="#cb31-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-489"><a href="#cb31-489" aria-hidden="true" tabindex="-1"></a>Due to time constraints, we will run one region and one gene only</span>
<span id="cb31-490"><a href="#cb31-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-491"><a href="#cb31-491" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Finemap GWAS of CAD</span>
<span id="cb31-492"><a href="#cb31-492" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Finemap eQTL of SORT1</span>
<span id="cb31-493"><a href="#cb31-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-494"><a href="#cb31-494" aria-hidden="true" tabindex="-1"></a>For finemapping, we need the summary statistics (effect size, standard errors, etc) and the correlation between SNPs (LD matrix)</span>
<span id="cb31-495"><a href="#cb31-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-496"><a href="#cb31-496" aria-hidden="true" tabindex="-1"></a><span class="fu">## load the genotype to calculate the ld matrix</span></span>
<span id="cb31-497"><a href="#cb31-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-498"><a href="#cb31-498" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-499"><a href="#cb31-499" aria-hidden="true" tabindex="-1"></a><span class="co"># load the genotype to calculate the ld matrix</span></span>
<span id="cb31-500"><a href="#cb31-500" aria-hidden="true" tabindex="-1"></a>X_mat <span class="ot">&lt;-</span> <span class="fu">BEDMatrix</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/colocalization/geuvadis_chr1"</span>))</span>
<span id="cb31-501"><a href="#cb31-501" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(X_mat) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">_.*"</span>, <span class="st">""</span>,<span class="fu">colnames</span>(X_mat))</span>
<span id="cb31-502"><a href="#cb31-502" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(X_mat) <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(<span class="fu">colnames</span>(X_mat),<span class="st">":"</span>,<span class="st">"_"</span>)</span>
<span id="cb31-503"><a href="#cb31-503" aria-hidden="true" tabindex="-1"></a>snp_info <span class="ot">&lt;-</span> <span class="fu">fread</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/colocalization/geuvadis_chr1.bim"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-504"><a href="#cb31-504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setnames</span>(., <span class="fu">colnames</span>(.), <span class="fu">c</span>(<span class="st">"chr"</span>, <span class="st">"snp"</span>, <span class="st">"cm"</span>, <span class="st">"pos"</span>, <span class="st">"alt"</span>, <span class="st">"ref"</span>)) </span>
<span id="cb31-505"><a href="#cb31-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-506"><a href="#cb31-506" aria-hidden="true" tabindex="-1"></a>snp_info<span class="sc">$</span>snp <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(snp_info<span class="sc">$</span>snp,<span class="st">":"</span>,<span class="st">"_"</span>)</span>
<span id="cb31-507"><a href="#cb31-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-508"><a href="#cb31-508" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-509"><a href="#cb31-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-510"><a href="#cb31-510" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load the eqtl and gwas effect size files</span></span>
<span id="cb31-511"><a href="#cb31-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-512"><a href="#cb31-512" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-513"><a href="#cb31-513" aria-hidden="true" tabindex="-1"></a><span class="co"># load the eqtl effect sizes</span></span>
<span id="cb31-514"><a href="#cb31-514" aria-hidden="true" tabindex="-1"></a>gene_ss <span class="ot">&lt;-</span> <span class="fu">fread</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/colocalization/Liver_chr1.txt"</span>))</span>
<span id="cb31-515"><a href="#cb31-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-516"><a href="#cb31-516" aria-hidden="true" tabindex="-1"></a><span class="co"># load gwas effect sizes</span></span>
<span id="cb31-517"><a href="#cb31-517" aria-hidden="true" tabindex="-1"></a>gwas <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/spredixcan/imputed_CARDIoGRAM_C4D_CAD_ADDITIVE.txt.gz"</span>))</span>
<span id="cb31-518"><a href="#cb31-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-519"><a href="#cb31-519" aria-hidden="true" tabindex="-1"></a><span class="co"># filter to select genome wide significant snps at 5 × 10−8</span></span>
<span id="cb31-520"><a href="#cb31-520" aria-hidden="true" tabindex="-1"></a>filtered_regions <span class="ot">&lt;-</span> gwas <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(pvalue <span class="sc">&lt;</span> <span class="fl">5e-8</span>)</span>
<span id="cb31-521"><a href="#cb31-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-522"><a href="#cb31-522" aria-hidden="true" tabindex="-1"></a><span class="co"># load the ld block</span></span>
<span id="cb31-523"><a href="#cb31-523" aria-hidden="true" tabindex="-1"></a>ldblocks <span class="ot">&lt;-</span><span class="fu">read_tsv</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/spredixcan/eur_ld.hg38.txt.gz"</span>))</span>
<span id="cb31-524"><a href="#cb31-524" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-525"><a href="#cb31-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-526"><a href="#cb31-526" aria-hidden="true" tabindex="-1"></a><span class="fu">## Find regions with the strongest signal in the gwas</span></span>
<span id="cb31-527"><a href="#cb31-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-528"><a href="#cb31-528" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-529"><a href="#cb31-529" aria-hidden="true" tabindex="-1"></a><span class="co"># get the loci where the significant snps are located</span></span>
<span id="cb31-530"><a href="#cb31-530" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(filtered_regions)){</span>
<span id="cb31-531"><a href="#cb31-531" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract genename, start and end</span></span>
<span id="cb31-532"><a href="#cb31-532" aria-hidden="true" tabindex="-1"></a>  variant_id <span class="ot">&lt;-</span> <span class="fu">as.character</span>(filtered_regions[n,<span class="st">"variant_id"</span>])</span>
<span id="cb31-533"><a href="#cb31-533" aria-hidden="true" tabindex="-1"></a>  variant_chr <span class="ot">&lt;-</span> <span class="fu">as.character</span>(filtered_regions[n,<span class="st">"chromosome"</span>])</span>
<span id="cb31-534"><a href="#cb31-534" aria-hidden="true" tabindex="-1"></a>  variant_pos <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(filtered_regions[n,<span class="st">"position"</span>])</span>
<span id="cb31-535"><a href="#cb31-535" aria-hidden="true" tabindex="-1"></a>  <span class="co">#gene_end &lt;- as.numeric(genes[n,"end"])</span></span>
<span id="cb31-536"><a href="#cb31-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-537"><a href="#cb31-537" aria-hidden="true" tabindex="-1"></a>  locus <span class="ot">&lt;-</span> ldblocks <span class="sc">%&gt;%</span></span>
<span id="cb31-538"><a href="#cb31-538" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(chr <span class="sc">==</span> variant_chr) <span class="sc">%&gt;%</span></span>
<span id="cb31-539"><a href="#cb31-539" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(variant_pos <span class="sc">&gt;=</span> start <span class="sc">&amp;</span> variant_pos <span class="sc">&lt;</span> stop) <span class="sc">%&gt;%</span></span>
<span id="cb31-540"><a href="#cb31-540" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">locus_name =</span> <span class="fu">paste0</span>(chr,<span class="st">"_"</span>,start,<span class="st">"_"</span>,stop)) <span class="sc">%&gt;%</span></span>
<span id="cb31-541"><a href="#cb31-541" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">locus_start=</span>start,<span class="at">locus_end=</span>stop) <span class="sc">%&gt;%</span></span>
<span id="cb31-542"><a href="#cb31-542" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">variant_id =</span> variant_id, <span class="at">position=</span>variant_pos)</span>
<span id="cb31-543"><a href="#cb31-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-544"><a href="#cb31-544" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a data frame with info</span></span>
<span id="cb31-545"><a href="#cb31-545" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">'all_loci'</span>) <span class="sc">&amp;&amp;</span> <span class="fu">is.data.frame</span>(<span class="fu">get</span>(<span class="st">'all_loci'</span>))) {</span>
<span id="cb31-546"><a href="#cb31-546" aria-hidden="true" tabindex="-1"></a>    all_loci <span class="ot">&lt;-</span> <span class="fu">rbind</span>(all_loci,locus)</span>
<span id="cb31-547"><a href="#cb31-547" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb31-548"><a href="#cb31-548" aria-hidden="true" tabindex="-1"></a>    all_loci <span class="ot">&lt;-</span> locus</span>
<span id="cb31-549"><a href="#cb31-549" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-550"><a href="#cb31-550" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-551"><a href="#cb31-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-552"><a href="#cb31-552" aria-hidden="true" tabindex="-1"></a><span class="co"># select uniq loci</span></span>
<span id="cb31-553"><a href="#cb31-553" aria-hidden="true" tabindex="-1"></a>d_loci <span class="ot">&lt;-</span> all_loci <span class="sc">%&gt;%</span></span>
<span id="cb31-554"><a href="#cb31-554" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(locus_name,chr,locus_start,locus_end) <span class="sc">%&gt;%</span></span>
<span id="cb31-555"><a href="#cb31-555" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>()</span>
<span id="cb31-556"><a href="#cb31-556" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-557"><a href="#cb31-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-558"><a href="#cb31-558" aria-hidden="true" tabindex="-1"></a><span class="fu">## select a region to run coloc</span></span>
<span id="cb31-559"><a href="#cb31-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-560"><a href="#cb31-560" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-561"><a href="#cb31-561" aria-hidden="true" tabindex="-1"></a><span class="co"># select regions to fine map. we are going to use regions in chromosome 1</span></span>
<span id="cb31-562"><a href="#cb31-562" aria-hidden="true" tabindex="-1"></a>uniq_loci <span class="ot">&lt;-</span> d_loci <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="st">"chr1"</span> <span class="sc">==</span> chr)</span>
<span id="cb31-563"><a href="#cb31-563" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="dv">3</span> <span class="co"># chr1_107867043_109761309 region</span></span>
<span id="cb31-564"><a href="#cb31-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-565"><a href="#cb31-565" aria-hidden="true" tabindex="-1"></a><span class="co"># extract information</span></span>
<span id="cb31-566"><a href="#cb31-566" aria-hidden="true" tabindex="-1"></a>l_chr <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(uniq_loci[n,<span class="st">"chr"</span>],<span class="st">"chr"</span>))</span>
<span id="cb31-567"><a href="#cb31-567" aria-hidden="true" tabindex="-1"></a>s_chr <span class="ot">=</span> uniq_loci[n,]<span class="sc">$</span>chr</span>
<span id="cb31-568"><a href="#cb31-568" aria-hidden="true" tabindex="-1"></a>l_start <span class="ot">=</span> uniq_loci[n,]<span class="sc">$</span>locus_start</span>
<span id="cb31-569"><a href="#cb31-569" aria-hidden="true" tabindex="-1"></a>l_stop <span class="ot">=</span> uniq_loci[n,]<span class="sc">$</span>locus_end</span>
<span id="cb31-570"><a href="#cb31-570" aria-hidden="true" tabindex="-1"></a>l_name <span class="ot">=</span> uniq_loci[n,]<span class="sc">$</span>locus_name</span>
<span id="cb31-571"><a href="#cb31-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-572"><a href="#cb31-572" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-573"><a href="#cb31-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-574"><a href="#cb31-574" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prepare gwas data for coloc</span></span>
<span id="cb31-575"><a href="#cb31-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-576"><a href="#cb31-576" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-577"><a href="#cb31-577" aria-hidden="true" tabindex="-1"></a><span class="co"># select snps for the region from the summary stats</span></span>
<span id="cb31-578"><a href="#cb31-578" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> gwas <span class="sc">%&gt;%</span> </span>
<span id="cb31-579"><a href="#cb31-579" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(chromosome <span class="sc">==</span> s_chr) <span class="sc">%&gt;%</span></span>
<span id="cb31-580"><a href="#cb31-580" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(position <span class="sc">&gt;=</span> l_start <span class="sc">&amp;</span> position <span class="sc">&lt;=</span> l_stop) <span class="sc">%&gt;%</span> </span>
<span id="cb31-581"><a href="#cb31-581" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span> <span class="fu">is.na</span>(effect_size))</span>
<span id="cb31-582"><a href="#cb31-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-583"><a href="#cb31-583" aria-hidden="true" tabindex="-1"></a><span class="co"># find the snps in the genotype to calculate the correlation</span></span>
<span id="cb31-584"><a href="#cb31-584" aria-hidden="true" tabindex="-1"></a>g.snps <span class="ot">&lt;-</span> ss <span class="sc">%&gt;%</span> <span class="fu">inner_join</span>(snp_info <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">chr =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"chr{chr}"</span>)), </span>
<span id="cb31-585"><a href="#cb31-585" aria-hidden="true" tabindex="-1"></a>                            <span class="at">by=</span><span class="fu">c</span>(<span class="st">"chromosome"</span> <span class="ot">=</span> <span class="st">"chr"</span>,<span class="st">"panel_variant_id"</span> <span class="ot">=</span> <span class="st">"snp"</span>))</span>
<span id="cb31-586"><a href="#cb31-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-587"><a href="#cb31-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-588"><a href="#cb31-588" aria-hidden="true" tabindex="-1"></a><span class="co"># select genotype to calculate correlation</span></span>
<span id="cb31-589"><a href="#cb31-589" aria-hidden="true" tabindex="-1"></a><span class="co">#f_mat &lt;- X_mat[,g.snps$snp]</span></span>
<span id="cb31-590"><a href="#cb31-590" aria-hidden="true" tabindex="-1"></a>f_mat <span class="ot">&lt;-</span> X_mat[,g.snps<span class="sc">$</span>panel_variant_id]</span>
<span id="cb31-591"><a href="#cb31-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-592"><a href="#cb31-592" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate corr</span></span>
<span id="cb31-593"><a href="#cb31-593" aria-hidden="true" tabindex="-1"></a>R <span class="ot">=</span> <span class="fu">cora</span>(f_mat) <span class="co"># the package is for speed</span></span>
<span id="cb31-594"><a href="#cb31-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-595"><a href="#cb31-595" aria-hidden="true" tabindex="-1"></a><span class="do">## clean up</span></span>
<span id="cb31-596"><a href="#cb31-596" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(f_mat)</span>
<span id="cb31-597"><a href="#cb31-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-598"><a href="#cb31-598" aria-hidden="true" tabindex="-1"></a>ff <span class="ot">&lt;-</span> g.snps <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span> <span class="fu">is.na</span>(effect_size)) <span class="sc">%&gt;%</span> <span class="co">#select(-snp) %&gt;% </span></span>
<span id="cb31-599"><a href="#cb31-599" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">snp=</span>panel_variant_id,<span class="at">beta=</span>effect_size) <span class="sc">%&gt;%</span> </span>
<span id="cb31-600"><a href="#cb31-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">varbeta =</span> standard_error<span class="sc">^</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-601"><a href="#cb31-601" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(beta,varbeta,snp,position) <span class="sc">%&gt;%</span> <span class="fu">as.list</span>()</span>
<span id="cb31-602"><a href="#cb31-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-603"><a href="#cb31-603" aria-hidden="true" tabindex="-1"></a>ff<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">"cc"</span></span>
<span id="cb31-604"><a href="#cb31-604" aria-hidden="true" tabindex="-1"></a>ff<span class="sc">$</span>sdY <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb31-605"><a href="#cb31-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-606"><a href="#cb31-606" aria-hidden="true" tabindex="-1"></a>ff<span class="sc">$</span>LD <span class="ot">=</span> R</span>
<span id="cb31-607"><a href="#cb31-607" aria-hidden="true" tabindex="-1"></a>ff<span class="sc">$</span>N <span class="ot">=</span> <span class="dv">184305</span></span>
<span id="cb31-608"><a href="#cb31-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-609"><a href="#cb31-609" aria-hidden="true" tabindex="-1"></a><span class="do">## check the data (NULL means it's fine)</span></span>
<span id="cb31-610"><a href="#cb31-610" aria-hidden="true" tabindex="-1"></a><span class="fu">check_dataset</span>(ff)</span>
<span id="cb31-611"><a href="#cb31-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-612"><a href="#cb31-612" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-613"><a href="#cb31-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-614"><a href="#cb31-614" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prepare eqtl data for coloc</span></span>
<span id="cb31-615"><a href="#cb31-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-616"><a href="#cb31-616" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-617"><a href="#cb31-617" aria-hidden="true" tabindex="-1"></a><span class="co">#Using SORT1 gene and liver tissue</span></span>
<span id="cb31-618"><a href="#cb31-618" aria-hidden="true" tabindex="-1"></a>gene <span class="ot">&lt;-</span> gene_ss <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(gene_id <span class="sc">==</span> <span class="st">"ENSG00000134243.11"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-619"><a href="#cb31-619" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">snp =</span> variant_id,<span class="at">beta =</span> slope, <span class="at">MAF =</span> maf,</span>
<span id="cb31-620"><a href="#cb31-620" aria-hidden="true" tabindex="-1"></a>                <span class="at">pvalue =</span> pval_nominal) <span class="sc">%&gt;%</span> </span>
<span id="cb31-621"><a href="#cb31-621" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">varbeta =</span> slope_se<span class="sc">^</span><span class="dv">2</span>, <span class="at">name =</span> snp) <span class="sc">%&gt;%</span> </span>
<span id="cb31-622"><a href="#cb31-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span> <span class="fu">is.na</span>(varbeta)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-623"><a href="#cb31-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(name, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"chr"</span>, <span class="st">"position"</span>,<span class="st">"ref"</span>,<span class="st">"alt"</span>,<span class="st">"build"</span>),<span class="at">sep =</span> <span class="st">"_"</span>)</span>
<span id="cb31-624"><a href="#cb31-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-625"><a href="#cb31-625" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate the ld matrix</span></span>
<span id="cb31-626"><a href="#cb31-626" aria-hidden="true" tabindex="-1"></a><span class="do">### get the snps</span></span>
<span id="cb31-627"><a href="#cb31-627" aria-hidden="true" tabindex="-1"></a>gene.snps <span class="ot">&lt;-</span> gene <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">position =</span> <span class="fu">as.integer</span>(position)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-628"><a href="#cb31-628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(snp_info <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">chr =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"chr{chr}"</span>)), </span>
<span id="cb31-629"><a href="#cb31-629" aria-hidden="true" tabindex="-1"></a>                              <span class="at">by=</span><span class="fu">c</span>(<span class="st">"chr"</span> <span class="ot">=</span> <span class="st">"chr"</span>,<span class="st">"snp"</span> <span class="ot">=</span> <span class="st">"snp"</span>))</span>
<span id="cb31-630"><a href="#cb31-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-631"><a href="#cb31-631" aria-hidden="true" tabindex="-1"></a><span class="co"># select genotype to calculate correlation</span></span>
<span id="cb31-632"><a href="#cb31-632" aria-hidden="true" tabindex="-1"></a>g_mat <span class="ot">&lt;-</span> X_mat[,gene.snps<span class="sc">$</span>snp]</span>
<span id="cb31-633"><a href="#cb31-633" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate corr</span></span>
<span id="cb31-634"><a href="#cb31-634" aria-hidden="true" tabindex="-1"></a>g.R <span class="ot">=</span> <span class="fu">cora</span>(g_mat)</span>
<span id="cb31-635"><a href="#cb31-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-636"><a href="#cb31-636" aria-hidden="true" tabindex="-1"></a><span class="co"># clean up</span></span>
<span id="cb31-637"><a href="#cb31-637" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(g_mat)</span>
<span id="cb31-638"><a href="#cb31-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-639"><a href="#cb31-639" aria-hidden="true" tabindex="-1"></a><span class="co"># format data for coloc</span></span>
<span id="cb31-640"><a href="#cb31-640" aria-hidden="true" tabindex="-1"></a>gg <span class="ot">&lt;-</span> gene <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(snp <span class="sc">%in%</span> gene.snps<span class="sc">$</span>snp) <span class="sc">%&gt;%</span></span>
<span id="cb31-641"><a href="#cb31-641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">position =</span> <span class="fu">as.integer</span>(position)) <span class="sc">%&gt;%</span> </span>
<span id="cb31-642"><a href="#cb31-642" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(beta,varbeta,snp,position,MAF, pvalue) <span class="sc">%&gt;%</span> <span class="fu">as.list</span>()</span>
<span id="cb31-643"><a href="#cb31-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-644"><a href="#cb31-644" aria-hidden="true" tabindex="-1"></a>gg<span class="sc">$</span>type <span class="ot">&lt;-</span> <span class="st">"quant"</span></span>
<span id="cb31-645"><a href="#cb31-645" aria-hidden="true" tabindex="-1"></a>gg<span class="sc">$</span>LD <span class="ot">=</span> g.R</span>
<span id="cb31-646"><a href="#cb31-646" aria-hidden="true" tabindex="-1"></a>gg<span class="sc">$</span>N <span class="ot">=</span> <span class="dv">208</span> <span class="co"># 670 for blood</span></span>
<span id="cb31-647"><a href="#cb31-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-648"><a href="#cb31-648" aria-hidden="true" tabindex="-1"></a><span class="do">## check the data</span></span>
<span id="cb31-649"><a href="#cb31-649" aria-hidden="true" tabindex="-1"></a><span class="fu">check_dataset</span>(gg)</span>
<span id="cb31-650"><a href="#cb31-650" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-651"><a href="#cb31-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-652"><a href="#cb31-652" aria-hidden="true" tabindex="-1"></a><span class="fu">## run older version of coloc which assumes single causal variant</span></span>
<span id="cb31-653"><a href="#cb31-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-654"><a href="#cb31-654" aria-hidden="true" tabindex="-1"></a>*coloc.abf* makes the simplifying assumption that each trait has at most one causal variant in the region under consideration</span>
<span id="cb31-655"><a href="#cb31-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-656"><a href="#cb31-656" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-657"><a href="#cb31-657" aria-hidden="true" tabindex="-1"></a>my.res <span class="ot">&lt;-</span> <span class="fu">coloc.abf</span>(<span class="at">dataset1=</span>ff, <span class="at">dataset2=</span>gg)</span>
<span id="cb31-658"><a href="#cb31-658" aria-hidden="true" tabindex="-1"></a><span class="fu">sensitivity</span>(my.res,<span class="st">"H4 &gt; 0.9"</span>)</span>
<span id="cb31-659"><a href="#cb31-659" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-660"><a href="#cb31-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-661"><a href="#cb31-661" aria-hidden="true" tabindex="-1"></a><span class="fu">## run coloc allowing multiple causal variants</span></span>
<span id="cb31-662"><a href="#cb31-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-663"><a href="#cb31-663" aria-hidden="true" tabindex="-1"></a>Multiple causal variants, using SuSiE to separate the signals</span>
<span id="cb31-664"><a href="#cb31-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-665"><a href="#cb31-665" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-666"><a href="#cb31-666" aria-hidden="true" tabindex="-1"></a><span class="co"># Run susie fine maooing</span></span>
<span id="cb31-667"><a href="#cb31-667" aria-hidden="true" tabindex="-1"></a>S3 <span class="ot">=</span> <span class="fu">runsusie</span>(ff)</span>
<span id="cb31-668"><a href="#cb31-668" aria-hidden="true" tabindex="-1"></a>S4 <span class="ot">=</span> <span class="fu">runsusie</span>(gg)</span>
<span id="cb31-669"><a href="#cb31-669" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(S3)</span></span>
<span id="cb31-670"><a href="#cb31-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-671"><a href="#cb31-671" aria-hidden="true" tabindex="-1"></a><span class="co"># Run coloc</span></span>
<span id="cb31-672"><a href="#cb31-672" aria-hidden="true" tabindex="-1"></a>susie.res<span class="ot">=</span><span class="fu">coloc.susie</span>(S3,S4)</span>
<span id="cb31-673"><a href="#cb31-673" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(susie.res<span class="sc">$</span>summary)</span>
<span id="cb31-674"><a href="#cb31-674" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-675"><a href="#cb31-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-676"><a href="#cb31-676" aria-hidden="true" tabindex="-1"></a>SuSiE can take a while to run on larger datasets, so it is best to run once per dataset with the =runsusie= function, store the results and feed those into subsequent analyses.</span>
<span id="cb31-677"><a href="#cb31-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-678"><a href="#cb31-678" aria-hidden="true" tabindex="-1"></a>plot the coloc result with the sensitivity function because weird effects are much easier to understand visually</span>
<span id="cb31-679"><a href="#cb31-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-680"><a href="#cb31-680" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb31-681"><a href="#cb31-681" aria-hidden="true" tabindex="-1"></a><span class="fu">sensitivity</span>(susie.res,<span class="st">"H4 &gt; 0.9"</span>,<span class="at">row=</span><span class="dv">1</span>,<span class="at">dataset1=</span>ff,<span class="at">dataset2=</span>gg,)</span>
<span id="cb31-682"><a href="#cb31-682" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-683"><a href="#cb31-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-684"><a href="#cb31-684" aria-hidden="true" tabindex="-1"></a><span class="fu"># cTWAS</span></span>
<span id="cb31-685"><a href="#cb31-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-686"><a href="#cb31-686" aria-hidden="true" tabindex="-1"></a>cTWAS stands for causal TWAS and seeks to calculate the posterior inclusion probability of genes and SNPs in a given region to be causal. It's a modification of SUSIER that adds predicted gene expression levels in addition to SNPs in the analysis. It is not yet published, but the authors (Siming Zhao, Wesley Crouse, Matthew Stephens et al) have shared a vignette with us to try it out.</span>
<span id="cb31-687"><a href="#cb31-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-688"><a href="#cb31-688" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Thank you, Wes, for creating this portion of the lab!</span></span>
<span id="cb31-689"><a href="#cb31-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-690"><a href="#cb31-690" aria-hidden="true" tabindex="-1"></a><span class="fu">## Questionnaire 06</span></span>
<span id="cb31-691"><a href="#cb31-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-692"><a href="#cb31-692" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> Open and start filling out questionnaire 06 cTWAS https://forms.gle/A4evWkbhR7cXLy36A</span>
<span id="cb31-693"><a href="#cb31-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-694"><a href="#cb31-694" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,eval=FALSE}</span></span>
<span id="cb31-695"><a href="#cb31-695" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("R.utils")</span></span>
<span id="cb31-696"><a href="#cb31-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-697"><a href="#cb31-697" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("remotes")</span></span>
<span id="cb31-698"><a href="#cb31-698" aria-hidden="true" tabindex="-1"></a><span class="co">#remotes::install_github("simingz/ctwas", ref = "develop")</span></span>
<span id="cb31-699"><a href="#cb31-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-700"><a href="#cb31-700" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ctwas)</span>
<span id="cb31-701"><a href="#cb31-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-702"><a href="#cb31-702" aria-hidden="true" tabindex="-1"></a><span class="co">#get positions for region of interest (SORT1/PSRC1 locus)</span></span>
<span id="cb31-703"><a href="#cb31-703" aria-hidden="true" tabindex="-1"></a>region <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">strsplit</span>(spredixcan_association<span class="sc">$</span>region_id[spredixcan_association<span class="sc">$</span>gene_name<span class="sc">==</span><span class="st">"PSRC1"</span>], <span class="st">"_"</span>))</span>
<span id="cb31-704"><a href="#cb31-704" aria-hidden="true" tabindex="-1"></a>chr <span class="ot">&lt;-</span> region[<span class="dv">2</span>]</span>
<span id="cb31-705"><a href="#cb31-705" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(region[<span class="dv">3</span>])</span>
<span id="cb31-706"><a href="#cb31-706" aria-hidden="true" tabindex="-1"></a>end <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(region[<span class="dv">4</span>])</span>
<span id="cb31-707"><a href="#cb31-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-708"><a href="#cb31-708" aria-hidden="true" tabindex="-1"></a><span class="co">#format summary statistics (and subset to variants in region to save memory)</span></span>
<span id="cb31-709"><a href="#cb31-709" aria-hidden="true" tabindex="-1"></a>z_snp <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/spredixcan/imputed_CARDIoGRAM_C4D_CAD_ADDITIVE.txt.gz"</span>), <span class="at">select=</span><span class="fu">c</span>(<span class="st">"chromosome"</span>, <span class="st">"position"</span>, <span class="st">"variant_id"</span>, <span class="st">"effect_allele"</span>, <span class="st">"non_effect_allele"</span>, <span class="st">"zscore"</span>, <span class="st">"sample_size"</span>))</span>
<span id="cb31-710"><a href="#cb31-710" aria-hidden="true" tabindex="-1"></a>z_snp <span class="ot">&lt;-</span> z_snp[z_snp<span class="sc">$</span>chromosome<span class="sc">==</span>chr <span class="sc">&amp;</span> z_snp<span class="sc">$</span>position <span class="sc">&gt;=</span> start <span class="sc">&amp;</span> z_snp<span class="sc">$</span>position <span class="sc">&lt;=</span> end,]</span>
<span id="cb31-711"><a href="#cb31-711" aria-hidden="true" tabindex="-1"></a>z_snp <span class="ot">&lt;-</span> z_snp[<span class="sc">!</span><span class="fu">is.na</span>(z_snp<span class="sc">$</span>variant_id),<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]</span>
<span id="cb31-712"><a href="#cb31-712" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(z_snp) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"A1"</span>, <span class="st">"A2"</span>, <span class="st">"z"</span>, <span class="st">"ss"</span>)</span>
<span id="cb31-713"><a href="#cb31-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-714"><a href="#cb31-714" aria-hidden="true" tabindex="-1"></a><span class="co">#specify directories for LD matrices and weights</span></span>
<span id="cb31-715"><a href="#cb31-715" aria-hidden="true" tabindex="-1"></a>ld_R_dir <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/cTWAS/LD_matrices"</span>)</span>
<span id="cb31-716"><a href="#cb31-716" aria-hidden="true" tabindex="-1"></a>weight <span class="ot">&lt;-</span>  glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{MODEL}/gtex_v8_mashr/mashr_Liver.db"</span>)</span>
<span id="cb31-717"><a href="#cb31-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-718"><a href="#cb31-718" aria-hidden="true" tabindex="-1"></a><span class="co">#specify output locations and names for cTWAS</span></span>
<span id="cb31-719"><a href="#cb31-719" aria-hidden="true" tabindex="-1"></a>outputdir <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{DATA}/cTWAS/results/"</span>)</span>
<span id="cb31-720"><a href="#cb31-720" aria-hidden="true" tabindex="-1"></a>outname.e <span class="ot">&lt;-</span> <span class="st">"CARDIoGRAM_Liver_expr"</span></span>
<span id="cb31-721"><a href="#cb31-721" aria-hidden="true" tabindex="-1"></a>outname <span class="ot">&lt;-</span> <span class="st">"CARDIoGRAM_Liver_ctwas"</span></span>
<span id="cb31-722"><a href="#cb31-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-723"><a href="#cb31-723" aria-hidden="true" tabindex="-1"></a><span class="co">#impute gene z scores using cTWAS and save the results</span></span>
<span id="cb31-724"><a href="#cb31-724" aria-hidden="true" tabindex="-1"></a><span class="do">##################################</span></span>
<span id="cb31-725"><a href="#cb31-725" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: we are skipping this step and using the precomputed values </span></span>
<span id="cb31-726"><a href="#cb31-726" aria-hidden="true" tabindex="-1"></a><span class="do">## takes ~10 minutes</span></span>
<span id="cb31-727"><a href="#cb31-727" aria-hidden="true" tabindex="-1"></a><span class="do">##################################</span></span>
<span id="cb31-728"><a href="#cb31-728" aria-hidden="true" tabindex="-1"></a><span class="co"># ctwas_imputation &lt;- impute_expr_z(z_snp=z_snp, weight=weight, ld_R_dir=ld_R_dir, outputdir=outputdir, outname=outname.e, harmonize_z=F, harmonize_wgt=F)</span></span>
<span id="cb31-729"><a href="#cb31-729" aria-hidden="true" tabindex="-1"></a><span class="co"># save(ctwas_imputation, file = paste0(outputdir, outname.e, "_output.Rd"))</span></span>
<span id="cb31-730"><a href="#cb31-730" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="fu">paste0</span>(outputdir, outname.e, <span class="st">"_output.Rd"</span>))</span>
<span id="cb31-731"><a href="#cb31-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-732"><a href="#cb31-732" aria-hidden="true" tabindex="-1"></a>z_gene <span class="ot">&lt;-</span> ctwas_imputation<span class="sc">$</span>z_gene</span>
<span id="cb31-733"><a href="#cb31-733" aria-hidden="true" tabindex="-1"></a>ld_exprfs <span class="ot">&lt;-</span> ctwas_imputation<span class="sc">$</span>ld_exprfs</span>
<span id="cb31-734"><a href="#cb31-734" aria-hidden="true" tabindex="-1"></a>z_snp <span class="ot">&lt;-</span> ctwas_imputation<span class="sc">$</span>z_snp</span>
<span id="cb31-735"><a href="#cb31-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-736"><a href="#cb31-736" aria-hidden="true" tabindex="-1"></a><span class="co">#make custom region file for single region</span></span>
<span id="cb31-737"><a href="#cb31-737" aria-hidden="true" tabindex="-1"></a>ld_regions_custom <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">"chr"</span> <span class="ot">=</span> chr, <span class="st">"start"</span> <span class="ot">=</span> start, <span class="st">"stop"</span> <span class="ot">=</span> end)</span>
<span id="cb31-738"><a href="#cb31-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-739"><a href="#cb31-739" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(ld_regions_custom, </span>
<span id="cb31-740"><a href="#cb31-740" aria-hidden="true" tabindex="-1"></a>            <span class="at">file=</span> <span class="fu">paste0</span>(outputdir, <span class="st">"ld_regions_custom.txt"</span>),</span>
<span id="cb31-741"><a href="#cb31-741" aria-hidden="true" tabindex="-1"></a>            <span class="at">row.names=</span>F, <span class="at">col.names=</span>T, <span class="at">sep=</span><span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">quote =</span> F)</span>
<span id="cb31-742"><a href="#cb31-742" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-743"><a href="#cb31-743" aria-hidden="true" tabindex="-1"></a>ld_regions_custom <span class="ot">&lt;-</span> <span class="fu">paste0</span>(outputdir, <span class="st">"ld_regions_custom.txt"</span>)</span>
<span id="cb31-744"><a href="#cb31-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-745"><a href="#cb31-745" aria-hidden="true" tabindex="-1"></a><span class="co">#run cTWAS with pre-specified prior parameters at a single locus</span></span>
<span id="cb31-746"><a href="#cb31-746" aria-hidden="true" tabindex="-1"></a><span class="co">#estimating prior requires genome-wide data, too slow for demonstration</span></span>
<span id="cb31-747"><a href="#cb31-747" aria-hidden="true" tabindex="-1"></a><span class="co">#prior is 1% inclusion for genes and is 100x more likely than SNPs</span></span>
<span id="cb31-748"><a href="#cb31-748" aria-hidden="true" tabindex="-1"></a><span class="co">#prior assumes genes have larger effect size than SNPs, in reasonable range for data we've looked at</span></span>
<span id="cb31-749"><a href="#cb31-749" aria-hidden="true" tabindex="-1"></a><span class="fu">ctwas_rss</span>(<span class="at">z_gene=</span>z_gene, <span class="at">z_snp=</span>z_snp, <span class="at">ld_exprfs=</span>ld_exprfs, <span class="at">ld_R_dir =</span> ld_R_dir, <span class="at">ld_regions_custom=</span>ld_regions_custom, <span class="at">outputdir =</span> outputdir, <span class="at">outname =</span> outname, <span class="at">thin =</span> <span class="fl">0.01</span>,</span>
<span id="cb31-750"><a href="#cb31-750" aria-hidden="true" tabindex="-1"></a>          <span class="at">estimate_group_prior =</span> F,</span>
<span id="cb31-751"><a href="#cb31-751" aria-hidden="true" tabindex="-1"></a>          <span class="at">estimate_group_prior_var =</span> F,</span>
<span id="cb31-752"><a href="#cb31-752" aria-hidden="true" tabindex="-1"></a>          <span class="at">group_prior=</span><span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.0001</span>),</span>
<span id="cb31-753"><a href="#cb31-753" aria-hidden="true" tabindex="-1"></a>          <span class="at">group_prior_var=</span><span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">25</span>))</span>
<span id="cb31-754"><a href="#cb31-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-755"><a href="#cb31-755" aria-hidden="true" tabindex="-1"></a><span class="co">#load results</span></span>
<span id="cb31-756"><a href="#cb31-756" aria-hidden="true" tabindex="-1"></a>ctwas_results <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="fu">paste0</span>(outputdir,outname,<span class="st">".susieIrss.txt"</span>))</span>
<span id="cb31-757"><a href="#cb31-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-758"><a href="#cb31-758" aria-hidden="true" tabindex="-1"></a><span class="co">#merge gene names into the results</span></span>
<span id="cb31-759"><a href="#cb31-759" aria-hidden="true" tabindex="-1"></a>sqlite <span class="ot">&lt;-</span> RSQLite<span class="sc">::</span><span class="fu">dbDriver</span>(<span class="st">"SQLite"</span>)</span>
<span id="cb31-760"><a href="#cb31-760" aria-hidden="true" tabindex="-1"></a>db <span class="ot">=</span> RSQLite<span class="sc">::</span><span class="fu">dbConnect</span>(sqlite, weight)</span>
<span id="cb31-761"><a href="#cb31-761" aria-hidden="true" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="cf">function</span>(...) RSQLite<span class="sc">::</span><span class="fu">dbGetQuery</span>(db, ...)</span>
<span id="cb31-762"><a href="#cb31-762" aria-hidden="true" tabindex="-1"></a>extra_table <span class="ot">&lt;-</span> <span class="fu">query</span>(<span class="st">"select * from extra"</span>)</span>
<span id="cb31-763"><a href="#cb31-763" aria-hidden="true" tabindex="-1"></a>RSQLite<span class="sc">::</span><span class="fu">dbDisconnect</span>(db)</span>
<span id="cb31-764"><a href="#cb31-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-765"><a href="#cb31-765" aria-hidden="true" tabindex="-1"></a>ctwas_results<span class="sc">$</span>genename <span class="ot">&lt;-</span> extra_table<span class="sc">$</span>genename[<span class="fu">match</span>(ctwas_results<span class="sc">$</span>id, extra_table<span class="sc">$</span>gene)]</span>
<span id="cb31-766"><a href="#cb31-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-767"><a href="#cb31-767" aria-hidden="true" tabindex="-1"></a><span class="co">#show results with highest PIPs</span></span>
<span id="cb31-768"><a href="#cb31-768" aria-hidden="true" tabindex="-1"></a>col_order_2<span class="ot">=</span> <span class="fu">c</span>(<span class="st">"genename"</span>, <span class="st">"chrom"</span>, <span class="st">"id"</span>, <span class="st">"pos"</span>, <span class="st">"type"</span>, <span class="st">"region_tag1"</span>, <span class="st">"region_tag2"</span>, <span class="st">"cs_index"</span>, <span class="st">"susie_pip"</span> , <span class="st">"mu2"</span>)</span>
<span id="cb31-769"><a href="#cb31-769" aria-hidden="true" tabindex="-1"></a>ctwas_results <span class="ot">&lt;-</span> ctwas_results[, ..col_order_2]</span>
<span id="cb31-770"><a href="#cb31-770" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ctwas_results[<span class="fu">order</span>(<span class="sc">-</span>ctwas_results<span class="sc">$</span>susie_pip),])</span>
<span id="cb31-771"><a href="#cb31-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-772"><a href="#cb31-772" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-773"><a href="#cb31-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-774"><a href="#cb31-774" aria-hidden="true" tabindex="-1"></a><span class="fu"># FAQ and frequent errors</span></span>
<span id="cb31-775"><a href="#cb31-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-776"><a href="#cb31-776" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>conda environment may not load correctly after resuming the project in Rstudio cloud</span>
<span id="cb31-777"><a href="#cb31-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-778"><a href="#cb31-778" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>when inner joining by ensemble id of genes, make sure that both datasets have either the same versions or remove versions</span>
<span id="cb31-779"><a href="#cb31-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-780"><a href="#cb31-780" aria-hidden="true" tabindex="-1"></a><span class="fu"># Contributors</span></span>
<span id="cb31-781"><a href="#cb31-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-782"><a href="#cb31-782" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Festus Nyasimi</span>
<span id="cb31-783"><a href="#cb31-783" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Margaret Perry</span>
<span id="cb31-784"><a href="#cb31-784" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Wes Crouse</span>
<span id="cb31-785"><a href="#cb31-785" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Owen Melia</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>