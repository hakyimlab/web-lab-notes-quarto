{
  "hash": "671c71cd1443284b59a5cb831731bb22",
  "result": {
    "markdown": "---\ntitle: \"Generate var(Z) for gene expression associations\"\nauthor: \"Festus\"\ndate: \"2023-07-25\"\n---\n\n\n## Set up\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(data.table)\nlibrary(tidyverse)\nin.dir <- \"/Volumes/im-lab/nas40t2/festus/metabolomics/metsim\"\ndata.dir <- \"/Volumes/im-lab/nas40t2/Data/1000G/vcf_hg38/\"\nset.seed(2023)\n```\n:::\n\n\nIn this analysis I predict the expression in the 1000G HapMap3 only SNPs which results into about 47% of the SNPs used\n\n\n::: {.cell}\n\n```{.bash .cell-code}\ndb=/gpfs/data/im-lab/nas40t2/Data/PredictDB/GTEx_v8/models_v1/eqtl/elastic_net_models/en_Whole_Blood.db\npython /home/fnyasimi1/MetaXcan/software/Predict.py \\\n  --model_db_path ${db} \\\n  --model_db_snp_key rsid \\\n  --vcf_genotypes /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/data/${size}/geuvadis_eur.vcf.gz \\\n  --vcf_mode genotyped \\\n  --prediction_output /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/predictions/${name}-${size}-hapmap.txt \\\n  --prediction_summary_output /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/predictions/${name}-${size}-hapmap_summary.txt \\\n  --skip_palindromic \\\n  --verbosity 9 \\\n  --throw\n\nRscript /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/gen_null.R \\\n   --predicted_traits /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/predictions/${name}-${size}-hapmap.txt \\\n   --plink_genotype /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/data/${size}/geuvadis_eur \\\n   --output_file /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/results/nullchi2/${name}-${size}.txt\n\n```\n:::\n\n\n## Load the null chi2\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsamp_400 <- fread(glue::glue(\"{in.dir}/geuvadis/results/nullchi2/en_Whole_Blood-400.txt\"))\nsamp_800 <- fread(glue::glue(\"{in.dir}/geuvadis/results/nullchi2/en_Whole_Blood-800.txt\"))\nsamp_1200 <- fread(glue::glue(\"{in.dir}/geuvadis/results/nullchi2/en_Whole_Blood-1200.txt\"))\nsamp_1600 <- fread(glue::glue(\"{in.dir}/geuvadis/results/nullchi2/en_Whole_Blood-1600.txt\"))\nsamp_2000 <- fread(glue::glue(\"{in.dir}/geuvadis/results/nullchi2/en_Whole_Blood-2000.txt\"))\nsamp_2500 <- fread(glue::glue(\"{in.dir}/geuvadis/results/nullchi2/en_Whole_Blood-2500.txt\"))\n\n\ndf_long <- reshape::melt(samp_400) %>% \n  mutate(samp = \"Sample size: 400\") %>% \n  bind_rows(reshape::melt(samp_800) %>% \n              mutate(samp = \"Sample size: 800\")) %>%\n  bind_rows(reshape::melt(samp_1200) %>% \n              mutate(samp = \"Sample size: 1200\")) %>%\n  bind_rows(reshape::melt(samp_1600) %>% \n              mutate(samp = \"Sample size: 1600\")) %>%\n  bind_rows(reshape::melt(samp_2000) %>% \n              mutate(samp = \"Sample size: 2000\")) %>%\n  bind_rows(reshape::melt(samp_2500) %>% \n              mutate(samp = \"Sample size: 2500\")) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsamps <- c(\"Sample size: 400\",\"Sample size: 800\",\"Sample size: 1200\",\"Sample size: 1600\",\"Sample size: 2000\", \"Sample size: 2500\")\n\nfor (sel_samp in samps) {\n  pt <- df_long %>% \n    filter(samp %in% sel_samp) %>% \n    ggplot(., aes(x = variable, y = value)) +\n      geom_boxplot() +\n      geom_hline(yintercept = 1, color = \"grey\") +\n      theme_bw() +\n      facet_wrap(~samp, ncol = 1) +\n      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),\n            plot.title = element_text(hjust = 0.5, face = \"bold\")) +\n      labs(x = expression(italic(h[2])), \n           y = expression(paste(italic(chi[2]))),\n           title = expression(paste(\"Distribution of \",italic(chi[2]),\" for each \", italic(h[2]))))\n  \n  print(pt)\n  \n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nherits <- c(\"h2_0.25\",\"h2_0.5\",\"h2_0.75\",\"h2_0.99\",\"h2_0.01\",\"h2_0.9\")\n\ndf_long %>% \n  filter(variable %in% herits) %>% \n  mutate(samp = as.numeric(str_remove(samp, \"Sample size: \"))) %>% \n  mutate(samp = factor(samp, levels = c(400,800,1200,1600,2000,2500))) %>% \n  ggplot(., aes(x = samp, y = value)) +\n    geom_boxplot() +\n    geom_hline(yintercept = 1, color = \"grey\") +\n    theme_bw() +\n    facet_wrap(~variable, ncol = 3) +\n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),\n          plot.title = element_text(hjust = 0.5, face = \"bold\")) +\n    labs(x = \"Sample size\", \n         y = expression(paste(italic(chi[2]))),\n         title = expression(paste(\"Distribution of \",italic(chi[2]),\" for each \", italic(h[2]))))\n```\n:::\n\n\n## Use whole genome for prediction\n\nIn the previous analysis I used about 47% of the SNPs for prediction. In my intution I thought this brings about alot of noise hence the reason we are getting higher avg chi^2^ under the null.\n\nIn this approach I will use all of the SNPs for prediction of gene expression but use HapMap3 SNPs for simulating the null. This approach will reduce the amount of noise in the predicted gene expression and hopefully give us more realistic results as we expect.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\ndb=/gpfs/data/im-lab/nas40t2/Data/PredictDB/GTEx_v8/models_v1/eqtl/elastic_net_models/en_Whole_Blood.db\npython /home/fnyasimi1/MetaXcan/software/Predict.py \\\n  --model_db_path ${db} \\\n  --model_db_snp_key varID \\\n  --on_the_fly_mapping METADATA \"{}_{}_{}_{}_b38\" \\\n  --vcf_genotypes /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis_eur/tmp_vcf/ALL.chr*.shapeit2_integrated_v1a.GRCh38.20181129.phased.vcf.gz \\\n  --text_sample_ids /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/data/${size}/samples.txt \\\n  --vcf_mode genotyped \\\n  --prediction_output /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/predictions/${name}-${size}-full.txt \\\n  --prediction_summary_output /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/predictions/${name}-${size}-full_summary.txt \\\n  --skip_palindromic \\\n  --verbosity 9 \\\n  --throw\n\nRscript /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/gen_null.R \\\n   --predicted_traits /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/predictions/${name}-${size}-full.txt \\\n   --plink_genotype /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/data/${size}/geuvadis_eur \\\n   --output_file /gpfs/data/im-lab/nas40t2/festus/metabolomics/metsim/geuvadis/results/nullchi2/${name}-${size}-full.txt\n```\n:::\n\n\n**INFO - 86 % of models' snps used** which is better compared to what we had before.\n\nSince I don't predict for all samples remove the NAs from the predicted expression\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfor (samp in c(400,800,1200,1600,2000,2500)) {\n  infile = glue::glue(\"{in.dir}/geuvadis/predictions/en_Whole_Blood-{samp}-full.txt\")\n  df <- fread(infile)\n  df <- df %>% filter(!is.na(IID))\n  fwrite(df, infile, sep = \"\\t\")\n}\n```\n:::\n\n\nLoad the data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsamp_400 <- fread(glue::glue(\"{in.dir}/geuvadis/results/nullchi2/en_Whole_Blood-400-full.txt\"))\nsamp_800 <- fread(glue::glue(\"{in.dir}/geuvadis/results/nullchi2/en_Whole_Blood-800-full.txt\"))\nsamp_1200 <- fread(glue::glue(\"{in.dir}/geuvadis/results/nullchi2/en_Whole_Blood-1200-full.txt\"))\nsamp_1600 <- fread(glue::glue(\"{in.dir}/geuvadis/results/nullchi2/en_Whole_Blood-1600-full.txt\"))\nsamp_2000 <- fread(glue::glue(\"{in.dir}/geuvadis/results/nullchi2/en_Whole_Blood-2000-full.txt\"))\nsamp_2500 <- fread(glue::glue(\"{in.dir}/geuvadis/results/nullchi2/en_Whole_Blood-2500-full.txt\"))\n\n\ndf_long_full <- reshape::melt(samp_400) %>% \n  mutate(samp = \"Sample size: 400\") %>% \n  bind_rows(reshape::melt(samp_800) %>% \n              mutate(samp = \"Sample size: 800\")) %>%\n  bind_rows(reshape::melt(samp_1200) %>% \n              mutate(samp = \"Sample size: 1200\")) %>%\n  bind_rows(reshape::melt(samp_1600) %>% \n              mutate(samp = \"Sample size: 1600\")) %>%\n  bind_rows(reshape::melt(samp_2000) %>% \n              mutate(samp = \"Sample size: 2000\")) %>%\n  bind_rows(reshape::melt(samp_2500) %>% \n              mutate(samp = \"Sample size: 2500\")) \n```\n:::\n\n\nLet's see the results we get with this one\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfor (sel_samp in samps) {\n  pt <- df_long_full %>% \n    filter(samp %in% sel_samp) %>% \n    ggplot(., aes(x = variable, y = value)) +\n      geom_boxplot() +\n      geom_hline(yintercept = 1, color = \"grey\") +\n      theme_bw() +\n      facet_wrap(~samp, ncol = 1) +\n      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),\n            plot.title = element_text(hjust = 0.5, face = \"bold\")) +\n      labs(x = expression(italic(h[2])), \n           y = expression(paste(italic(chi[2]))),\n           title = expression(paste(\"Distribution of \",italic(chi[2]),\" for each \", italic(h[2]))))\n  \n  print(pt)\n  \n}\n```\n:::\n\n\nThe average chi2 are very close to one compared to the previous approach where by we were getting very extreme results.\n\nI will have to figure out why at n =2500 we are getting the huge avg chi2 but the rest look good so far\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_long_full %>% \n  filter(variable %in% herits) %>% \n  mutate(samp = as.numeric(str_remove(samp, \"Sample size: \"))) %>% \n  mutate(samp = factor(samp, levels = c(400,800,1200,1600,2000,2500))) %>% \n  ggplot(., aes(x = samp, y = value)) +\n    geom_boxplot() +\n    geom_hline(yintercept = 1, color = \"grey\") +\n    theme_bw() +\n    facet_wrap(~variable, ncol = 3) +\n    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),\n          plot.title = element_text(hjust = 0.5, face = \"bold\")) +\n    labs(x = \"Sample size\", \n         y = expression(paste(italic(chi[2]))),\n         title = expression(paste(\"Distribution of \",italic(chi[2]),\" for each \", italic(h[2]))))\n```\n:::\n\n\nFrom the results we dont see inflation across different sample sizes under the null. Except for n=2500 not sure what is causing this.\n\n::: callout-note\n## results\n\nNow we are getting the results we expected in the prediction. This works when we use an appropriate number of SNPs from the model compared with what we had before.\n\nThe more SNPs used in the prediction, the more noise you reduce hence reduced inflation in the final results\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}